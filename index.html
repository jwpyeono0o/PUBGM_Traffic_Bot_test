<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Traffic by Country â€” Finviz-style Treemap</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- API ì„¤ì • íŒŒì¼ (ì„ íƒì‚¬í•­, ë¡œì»¬ ê°œë°œìš©) -->
    <script>
      // config.jsê°€ ìˆìœ¼ë©´ ë¡œë“œ, ì—†ìœ¼ë©´ ë¬´ì‹œ (404 ì—ëŸ¬ ë°©ì§€)
      // GitHub Pagesì—ì„œëŠ” config.jsê°€ ì—†ìœ¼ë¯€ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ë§Œ ê¸°ëŠ¥ì—ëŠ” ì˜í–¥ ì—†ìŒ
    </script>
    <style>
    :root{
      --bg:#262931; --panel:#161b22; --muted:#8b949e; --border:#30363d; --tile-gap:#262931; /* ë°°ê²½ ìƒ‰ìƒ */
      --green-weak:#39D353; --green-mid:#00C853; --green-strong:#00E676; --green-max:#00FF00;
      --red-weak:#FF6E6E; --red-mid:#FF3B3B; --red-strong:#FF1A1A; --red-max:#FF0000;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg),#161b22);color:#fff;min-height:100vh}
    .container{width:100%;max-width:100%;margin:0 auto;background:var(--bg)}
    .header{background:linear-gradient(135deg,#161b22,#1c2128);border-bottom:1px solid var(--border);padding:18px 40px}
    .header h1{font-size:20px;font-weight:700;letter-spacing:-.2px}
    .header p{font-size:12px;color:var(--muted);margin-top:4px;display:flex;align-items:center;gap:8px}
    .toolbar,.filter-controls{padding:14px 40px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .toolbar input[type="file"], .filter-controls input[type="number"], .filter-controls select{padding:8px 12px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px}
    .toolbar button{padding:8px 14px;background:linear-gradient(135deg,#238636,#2ea043);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer}
    .status-badge{background:linear-gradient(135deg,#238636,#2ea043);padding:6px 10px;border-radius:6px;font-size:12px}
    .content{padding:24px 40px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
    .stat-item{background:linear-gradient(135deg,#161b22,#1c2128);border:1px solid var(--border);border-radius:8px;padding:14px}
    .stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
    .stat-value{font-size:22px;font-weight:700}
    .stat-value.positive{color:#00ff00}
    .stat-value.negative{color:#ff4d4d}
    #treemap{width:100%;min-height:calc(100vh - 300px);background:var(--tile-gap);border:1px solid var(--border);border-radius:8px;position:relative;overflow:hidden}
    .loading-overlay{position:absolute;inset:0;background:rgba(13,17,23,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
    .loading-spinner{border:4px solid var(--border);border-top:4px solid #238636;border-radius:50%;width:46px;height:46px;animation:spin 1s linear infinite;margin-bottom:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .badge{display:inline-flex;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(135deg,#161b22,#1c2128);font-size:12px}
    .badge[data-tip]{position:relative}
    .badge[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 10px);white-space:nowrap;background:#161b22;color:#fff;padding:8px 10px;border-radius:8px;border:1px solid var(--border)}
    .tabs-container{background:var(--panel);border-bottom:1px solid var(--border);padding:0 40px}
    .tabs{display:flex;gap:0;overflow-x:auto}
    .tab-button{padding:14px 24px;background:transparent;border:none;border-bottom:3px solid transparent;color:var(--muted);font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.2s}
    .tab-button:hover{color:#fff;background:rgba(255,255,255,0.05)}
    .tab-button.active{color:#fff;border-bottom-color:#238636;background:rgba(35,134,54,0.1)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .risers-fallers-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
    .risers-section,.fallers-section{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:16px}
    .section-title{font-size:16px;color:var(--muted);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
    .country-list{max-height:600px;overflow-y:auto}
    .country-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);transition:background 0.2s}
    .country-item:hover{background:rgba(255,255,255,0.05)}
    .country-item:last-child{border-bottom:none}
    .country-name{font-size:14px;font-weight:600;color:#fff}
    .country-change{font-size:14px;font-weight:600}
    .country-change.positive{color:#00ff00}
    .country-change.negative{color:#ff4d4d}
    .country-detail-container{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:20px;margin-top:20px}
    .country-select-wrapper{margin-bottom:20px}
    .country-select-wrapper select{width:100%;padding:10px 12px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;font-size:14px}
    .country-search-wrapper{position:relative;margin-bottom:20px}
    .country-search-input{width:100%;padding:12px 40px 12px 16px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;font-size:14px}
    .country-search-input:focus{outline:none;border-color:#238636}
    .country-search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
    .country-autocomplete{position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--border);border-radius:6px;max-height:300px;overflow-y:auto;z-index:1000;margin-top:4px;display:none}
    .country-autocomplete-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.2s}
    .country-autocomplete-item:hover{background:rgba(255,255,255,0.05)}
    .country-autocomplete-item:last-child{border-bottom:none}
    .country-autocomplete-item.highlight{background:rgba(35,134,54,0.2);border-left:3px solid #238636}
    .quick-select-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:20px}
    .quick-select-btn{padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:13px;cursor:pointer;transition:all 0.2s;text-align:center}
    .quick-select-btn:hover{background:rgba(35,134,54,0.2);border-color:#238636}
    .quick-select-section{margin-bottom:20px}
    .quick-select-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;font-weight:600}
    .country-detail-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
    .detail-stat-item{background:linear-gradient(135deg,#161b22,#1c2128);border:1px solid var(--border);border-radius:8px;padding:16px}
    .detail-stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px}
    .detail-stat-value{font-size:24px;font-weight:700;color:#fff}
    .traffic-chart-container{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:20px;min-height:400px}
    .news-container{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:24px}
    .news-item{display:flex;gap:16px;padding:20px;border-bottom:1px solid var(--border);transition:background 0.2s}
    .news-item:hover{background:rgba(255,255,255,0.05)}
    .news-item:last-child{border-bottom:none}
    .news-content{flex:1}
    .news-title{font-size:17px;font-weight:600;color:#fff;margin-bottom:10px;line-height:1.4}
    .news-title a{color:#fff;text-decoration:none}
    .news-title a:hover{color:#238636}
    .news-meta{font-size:13px;color:var(--muted);display:flex;gap:12px;align-items:center}
    .news-source{color:#238636;font-weight:600}
    .news-date{color:var(--muted)}
    .news-snippet{font-size:15px;color:var(--muted);margin-top:10px;line-height:1.6}
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state-icon{font-size:48px;margin-bottom:16px;opacity:0.5}
    @media (max-width:768px){.header{padding:14px 16px}.content{padding:12px 16px}.filter-controls{padding:14px 16px}.tabs-container{padding:0 16px}.risers-fallers-grid{grid-template-columns:1fr}.tabs{overflow-x:auto}.tab-button{padding:12px 16px;font-size:13px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
      <h1>ğŸ¥¸ PUBGM ê¸€ë¡œë²Œ ì¶”ì´</h1>
        </div>
        
        <div class="toolbar">
      <input type="file" id="csvFile" accept=".csv"/>
      <button id="btnLoad">ğŸ“ Load CSV</button>
      <div class="status-badge" id="status">Sample Data (250 Countries)</div>
    </div>

    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-button active" data-tab="treemap">ğŸ“Š Treemap</button>
        <button class="tab-button" data-tab="risers-fallers">ğŸ“ˆ Risers/Fallers</button>
        <button class="tab-button" data-tab="country-detail">ğŸŒ Country Detail</button>
        <button class="tab-button" data-tab="news">ğŸ“° News & Headlines</button>
      </div>
    </div>

    <div class="filter-controls" id="treemapFilters">
      <label><strong>Show Top:</strong> <input type="number" id="topCount" value="180" min="10" max="250"/></label>
      <label><strong>Sort By:</strong>
        <select id="sortBy">
          <option value="revenue" selected>Total Traffic</option>
          <option value="change_desc">+ ë³€í™”ëŸ‰ í° ìˆœ</option>
          <option value="change_asc">- ë³€í™”ëŸ‰ í° ìˆœ</option>
        </select>
      </label>
      <!-- Group by ContinentëŠ” í•­ìƒ í™œì„±í™” (ìˆ¨ê¹€ ì²˜ë¦¬) -->
      <input type="checkbox" id="groupByContinent" checked style="display:none"/>
      <label style="margin-top:8px"><strong>Comparison:</strong>
        <select id="comparisonType" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;margin-left:8px;font-size:13px">
          <option value="DoD" selected>DoD (ì „ì¼ ëŒ€ë¹„)</option>
          <option value="WoW">WoW (ì£¼ê°„ í•©ê³„)</option>
          <option value="MoM">MoM (ì›”ê°„ í•©ê³„)</option>
          <option value="QoQ">QoQ (ë¶„ê¸° í•©ê³„)</option>
          <option value="YoY">YoY (ì „ë…„ ë™ì¼)</option>
          <option value="Period">Period (ê¸°ê°„ ì „ì²´)</option>
        </select>
        <span id="comparisonInfo" style="margin-left:8px;font-size:11px;color:var(--muted)"></span>
      </label>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px">
        <label><strong>Date Range:</strong></label>
        <input type="date" id="startDate" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px"/>
        <span style="color:var(--muted)">~</span>
        <input type="date" id="endDate" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px"/>
        <button id="btnApplyDateRange" style="padding:6px 12px;background:linear-gradient(135deg,#238636,#2ea043);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;font-size:12px">Apply</button>
        <button id="btnClearDateRange" style="padding:6px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-weight:600;cursor:pointer;font-size:12px">Clear</button>
        <span id="dateRangeIndicator" style="display:none;margin-left:8px;padding:6px 12px;background:rgba(35,134,54,0.15);border:1px solid rgba(35,134,54,0.3);border-radius:6px;font-size:12px;color:#2ed573">
          ğŸ“… <span id="dateRangeText"></span>
        </span>
      </div>
      <!-- ì›”ë³„ ì„ íƒ í•„í„° -->
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <label><strong>ğŸ“… ì›”ë³„ ì„ íƒ:</strong></label>
        <select id="monthSelect" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;min-width:140px">
          <option value="">ì›” ì„ íƒ...</option>
        </select>
        <span style="color:var(--muted);font-size:12px">vs</span>
        <select id="compareMonthSelect" style="padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;min-width:140px">
          <option value="">ë¹„êµ ì›” (ì„ íƒ)</option>
        </select>
        <button id="btnApplyMonth" style="padding:6px 12px;background:linear-gradient(135deg,#5352ed,#3742fa);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;font-size:12px">ì›”ë³„ ì ìš©</button>
        <button id="btnClearMonth" style="padding:6px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-weight:600;cursor:pointer;font-size:12px">ì´ˆê¸°í™”</button>
        <span id="monthIndicator" style="display:none;margin-left:8px;padding:6px 12px;background:rgba(83,82,237,0.15);border:1px solid rgba(83,82,237,0.3);border-radius:6px;font-size:12px;color:#5352ed">
          ğŸ“† <span id="monthText"></span>
        </span>
      </div>
        </div>
        
        <div class="content">
      <!-- Treemap Tab -->
      <div class="tab-content active" id="tab-treemap">
        <!-- ë°ì´í„° ê¸°ì¤€ ì •ë³´ í‘œì‹œ -->
        <div id="dataContextInfo" style="display:none;margin-bottom:16px;padding:14px 20px;background:linear-gradient(135deg,rgba(35,134,54,0.1),rgba(83,82,237,0.1));border:1px solid rgba(35,134,54,0.3);border-radius:10px">
          <div style="display:flex;flex-wrap:wrap;gap:24px;align-items:center">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-size:18px">ğŸ“…</span>
              <div>
                <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">ë°ì´í„° ê¸°ê°„</div>
                <div id="dataContextPeriod" style="font-size:14px;color:#fff;font-weight:600">-</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-size:18px">ğŸ“Š</span>
              <div>
                <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">ë³€í™”ìœ¨ ê¸°ì¤€</div>
                <div id="dataContextComparison" style="font-size:14px;color:#fff;font-weight:600">-</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-size:18px">ğŸ“</span>
              <div>
                <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">ë°ì´í„° ìˆ˜</div>
                <div id="dataContextRows" style="font-size:14px;color:#fff;font-weight:600">-</div>
              </div>
            </div>
          </div>
        </div>
        <div class="stats-grid" id="stats"></div>
        <div id="treemap">
          <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text" style="color:var(--muted)">ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
          </div>
        </div>
        <div class="color-palette" style="margin-top:20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px">
          <div style="font-size:12px;color:var(--muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">Color Palette</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#f63538;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">-3%</span>
            </div>
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#bf4045;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">-2%</span>
            </div>
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#8b444e;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">-1%</span>
            </div>
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#414554;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">0%</span>
            </div>
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#3e7c55;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">+1%</span>
            </div>
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#2f9e4f;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">+2%</span>
            </div>
            <div class="palette-item" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
              <div style="width:24px;height:24px;background:#30cc5a;border-radius:4px;border:1px solid rgba(255,255,255,0.1)"></div>
              <span style="color:#fff;font-size:13px;font-weight:600">+3%</span>
            </div>
          </div>
        </div>
        <div id="trafficTop10" style="margin-top:20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px">
          <div id="trafficTop10Title" style="font-size:16px;color:var(--muted);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">Traffic Top 10 (DoD ê¸°ì¤€)</div>
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="border-bottom:1px solid var(--border)">
                  <th style="padding:12px;text-align:left;font-size:14px;color:var(--muted);font-weight:600">Rank</th>
                  <th style="padding:12px;text-align:left;font-size:14px;color:var(--muted);font-weight:600">Country</th>
                  <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">Traffic</th>
                  <th style="padding:12px;text-align:right;font-size:14px;color:var(--muted);font-weight:600">Change</th>
                </tr>
              </thead>
              <tbody id="trafficTop10Body">
                <tr><td colspan="4" style="padding:16px;text-align:center;color:var(--muted);font-size:14px">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Risers/Fallers Tab -->
      <div class="tab-content" id="tab-risers-fallers">
        <div style="margin-bottom:20px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px">
          <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:8px">
              <strong style="color:var(--muted);font-size:14px">ìµœì†Œ íŠ¸ë˜í”½ í•„í„°:</strong>
              <input type="number" id="risersFallersTrafficFilter" value="50000" min="0" step="1000" style="padding:8px 12px;border:1px solid var(--border);background:var(--bg);color:#fff;border-radius:6px;width:120px;font-size:14px"/>
              <span style="color:var(--muted);font-size:13px">ì´ìƒ</span>
            </label>
            <div style="font-size:12px;color:var(--muted);padding:8px 12px;background:rgba(35,134,54,0.1);border:1px solid rgba(35,134,54,0.3);border-radius:6px">
              ğŸ’¡ 5% ì´ìƒ ë³€í™” + íŠ¸ë˜í”½ í•„í„° ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” êµ­ê°€ë§Œ í‘œì‹œë©ë‹ˆë‹¤
            </div>
          </div>
        </div>
        <div class="risers-fallers-grid">
          <div class="risers-section">
            <div class="section-title" id="risersTitle" style="color:#00ff00">ğŸ“ˆ Risers (5% ì´ìƒ ìƒìŠ¹)</div>
            <div class="country-list" id="risersList">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“Š</div>
                <div>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
              </div>
            </div>
          </div>
          <div class="fallers-section">
            <div class="section-title" id="fallersTitle" style="color:#ff4d4d">ğŸ“‰ Fallers (5% ì´ìƒ í•˜ë½)</div>
            <div class="country-list" id="fallersList">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“Š</div>
                <div>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Country Detail Tab -->
      <div class="tab-content" id="tab-country-detail">
        <div class="country-detail-container">
          <!-- ë¹ ë¥¸ ì„ íƒ: Top 10 êµ­ê°€ -->
          <div class="quick-select-section">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px">
              <div class="quick-select-title" style="margin-bottom:0">ğŸš€ ë¹ ë¥¸ ì„ íƒ (Traffic Top 10)</div>
              <div style="display:flex;gap:8px;align-items:center">
                <span id="top10DateInfo" style="font-size:12px;color:var(--muted)"></span>
                <div style="display:flex;background:var(--panel);border:1px solid var(--border);border-radius:6px;overflow:hidden">
                  <button id="top10LastDay" class="top10-mode-btn active" onclick="setTop10Mode('lastDay')" style="padding:6px 12px;font-size:12px;border:none;background:var(--accent);color:white;cursor:pointer;transition:all 0.2s">ë§ˆì§€ë§‰ ì¼</button>
                  <button id="top10Cumulative" class="top10-mode-btn" onclick="setTop10Mode('cumulative')" style="padding:6px 12px;font-size:12px;border:none;background:transparent;color:var(--text);cursor:pointer;transition:all 0.2s">ê¸°ê°„ ëˆ„ì </button>
                </div>
              </div>
            </div>
            <div class="quick-select-grid" id="quickSelectTop10"></div>
          </div>
          
          <!-- ê²€ìƒ‰ ê¸°ëŠ¥ -->
          <div class="country-search-wrapper">
            <input type="text" id="countrySearch" class="country-search-input" placeholder="ğŸ” êµ­ê°€ëª… ê²€ìƒ‰ (ì˜ˆ: USA, China, Korea...)"/>
            <div class="country-search-icon">ğŸ”</div>
            <div class="country-autocomplete" id="countryAutocomplete"></div>
          </div>
          
          <!-- ë“œë¡­ë‹¤ìš´ (ê¸°ì¡´ ë°©ì‹, ìˆ¨ê¹€ ì²˜ë¦¬) -->
          <div class="country-select-wrapper" style="display:none">
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px;font-weight:600">êµ­ê°€ ì„ íƒ:</label>
            <select id="countrySelect">
              <option value="">êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
          </div>
          
          <div id="countryDetailContent" style="display:none">
            <div class="country-detail-stats" id="countryDetailStats"></div>
            <div class="traffic-chart-container">
              <div id="countryTrafficChart" style="min-height:400px"></div>
            </div>
          </div>
          <div id="countryDetailEmpty" class="empty-state">
            <div class="empty-state-icon">ğŸŒ</div>
            <div>êµ­ê°€ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">ğŸ’¡ Treemapì´ë‚˜ Risers/Fallersì—ì„œ êµ­ê°€ë¥¼ í´ë¦­í•´ë„ ìë™ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>

      <!-- News & Headlines Tab -->
      <div class="tab-content" id="tab-news">
        <div class="news-container">
          <div style="margin-bottom:20px">
            <div class="section-title" style="margin:0">ğŸ“° News & Headlines</div>
          </div>
          
          <!-- ğŸ”¥ íŠ¸ë˜í”½ ì˜í–¥ ìš”ì•½ ì„¹ì…˜ (AI ë¶„ì„) -->
          <div id="trafficSummarySection" style="margin-bottom:24px;padding:20px;background:linear-gradient(135deg, rgba(255,107,107,0.1), rgba(83,82,237,0.1));border:1px solid rgba(255,107,107,0.3);border-radius:12px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
              <div style="width:40px;height:40px;background:linear-gradient(135deg,#ff6b6b,#ee5a24);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ“Š</div>
              <div>
                <div style="font-size:16px;font-weight:700;color:#fff">íŠ¸ë˜í”½ ì˜í–¥ ë¶„ì„</div>
                <div style="font-size:12px;color:var(--muted)">ìµœê·¼ 24ì‹œê°„ ìˆ˜ì§‘ ë‰´ìŠ¤ ê¸°ë°˜</div>
              </div>
            </div>
            <div id="trafficSummaryContent" style="font-size:14px;line-height:1.8;color:#e0e0e0">
              <div style="display:flex;align-items:center;gap:8px;color:var(--muted)">
                <div class="loading-spinner" style="width:16px;height:16px;border-width:2px"></div>
                ë¶„ì„ ì¤‘...
              </div>
            </div>
            <div id="trafficSummaryMeta" style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);display:none">
              <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--muted)">
                <span>ğŸ• ë¶„ì„ ì‹œê°„: <span id="summaryTime">-</span></span>
                <span>ğŸ“° ë¶„ì„ ë‰´ìŠ¤: <span id="summaryNewsCount">0</span>ê°œ</span>
              </div>
            </div>
          </div>
          
          <!-- ë‰´ìŠ¤ í•„í„° ì¹´ë“œ -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
            <button class="news-type-filter active" data-type="all" style="padding:16px;background:linear-gradient(135deg,#238636,#2ea043);border:none;border-radius:12px;color:#fff;cursor:pointer;transition:all 0.2s;text-align:left">
              <div style="font-size:24px;margin-bottom:8px">ğŸ“°</div>
              <div style="font-size:14px;font-weight:700">ì „ì²´ ë‰´ìŠ¤</div>
              <div style="font-size:12px;opacity:0.8;margin-top:4px"><span id="totalNewsCount">0</span>ê°œ</div>
            </button>
            <button class="news-type-filter" data-type="traffic_impact" style="padding:16px;background:var(--panel);border:2px solid #ff6b6b;border-radius:12px;color:#ff6b6b;cursor:pointer;transition:all 0.2s;text-align:left">
              <div style="font-size:24px;margin-bottom:8px">âš¡</div>
              <div style="font-size:14px;font-weight:700">íŠ¸ë˜í”½ ì˜í–¥</div>
              <div style="font-size:12px;opacity:0.8;margin-top:4px"><span id="trafficNewsCount">0</span>ê°œ</div>
            </button>
            <button class="news-type-filter" data-type="gaming" style="padding:16px;background:var(--panel);border:2px solid #5352ed;border-radius:12px;color:#5352ed;cursor:pointer;transition:all 0.2s;text-align:left">
              <div style="font-size:24px;margin-bottom:8px">ğŸ®</div>
              <div style="font-size:14px;font-weight:700">ê²Œì„ ë‰´ìŠ¤</div>
              <div style="font-size:12px;opacity:0.8;margin-top:4px"><span id="gamingNewsCount">0</span>ê°œ</div>
            </button>
          </div>
          
          <!-- ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ í•„í„° (ì ‘ì´ì‹) -->
          <div style="margin-bottom:20px">
            <button id="toggleCategoryFilter" style="width:100%;padding:12px 16px;background:var(--panel);border:1px solid var(--border);border-radius:8px;color:var(--muted);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:13px">
              <span>ğŸ·ï¸ ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ í•„í„°</span>
              <span id="categoryToggleIcon">â–¼</span>
            </button>
            <div id="categoryFilterSection" style="margin-top:12px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:8px;display:none">
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">
                <button class="category-filter active" data-category="all" style="padding:10px 12px;background:linear-gradient(135deg,#238636,#2ea043);border:none;border-radius:8px;color:#fff;font-size:12px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span>âœ“</span> ì „ì²´ ë³´ê¸°
                </button>
                <button class="category-filter" data-category="outage_block" style="padding:10px 12px;background:rgba(255,71,87,0.1);border:2px solid #ff4757;border-radius:8px;color:#ff4757;font-size:12px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span>ğŸ”´</span> ì¥ì• /ì°¨ë‹¨
                </button>
                <button class="category-filter" data-category="social_crisis" style="padding:10px 12px;background:rgba(255,165,2,0.1);border:2px solid #ffa502;border-radius:8px;color:#ffa502;font-size:12px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span>ğŸŸ </span> ì‚¬íšŒ ìœ„ê¸°
                </button>
                <button class="category-filter" data-category="seasonal_calendar" style="padding:10px 12px;background:rgba(46,213,115,0.1);border:2px solid #2ed573;border-radius:8px;color:#2ed573;font-size:12px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span>ğŸŸ¢</span> ì‹œì¦Œ/ì¼ì •
                </button>
                <button class="category-filter" data-category="gaming_competitor" style="padding:10px 12px;background:rgba(83,82,237,0.1);border:2px solid #5352ed;border-radius:8px;color:#5352ed;font-size:12px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span>ğŸ”µ</span> ê²Œì„/ê²½ìŸ
                </button>
                <button class="category-filter" data-category="other" style="padding:10px 12px;background:rgba(149,165,166,0.1);border:2px solid #95a5a6;border-radius:8px;color:#95a5a6;font-size:12px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span>âšª</span> ê¸°íƒ€
                </button>
              </div>
            </div>
          </div>
          
          <div id="newsList">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“°</div>
              <div>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              <div style="margin-top:12px;font-size:12px;color:var(--muted)">CSV íŒŒì¼ì—ì„œ ë‰´ìŠ¤ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>
        </div>
        
    <div class="footer" style="padding:14px;background:var(--panel);border-top:1px solid var(--border);color:var(--muted);text-align:center;font-size:12px">
      ğŸ“Š CSV Format: Date,Country,Traffic (ë‚ ì§œëŠ” ì¤‘êµ¬ë‚œë°© ê°€ëŠ¥, ë‚˜ë¼ë³„ ìë™ í”¼ë²—) Â· Hover tiles for details
        </div>
    </div>

    <script>
    // ---------- Mapping: Country â†’ Continent (Sector) ----------
    const countryToContinent = {
      'USA':'NORTH AMERICA','Canada':'NORTH AMERICA','Mexico':'NORTH AMERICA','Guatemala':'NORTH AMERICA','Honduras':'NORTH AMERICA','El Salvador':'NORTH AMERICA','Nicaragua':'NORTH AMERICA','Costa Rica':'NORTH AMERICA','Panama':'NORTH AMERICA','Cuba':'NORTH AMERICA','Jamaica':'NORTH AMERICA','Haiti':'NORTH AMERICA','Dominican Republic':'NORTH AMERICA','Trinidad':'NORTH AMERICA','Barbados':'NORTH AMERICA','Bahamas':'NORTH AMERICA','Belize':'NORTH AMERICA',
      'Brazil':'SOUTH AMERICA','Argentina':'SOUTH AMERICA','Chile':'SOUTH AMERICA','Colombia':'SOUTH AMERICA','Peru':'SOUTH AMERICA','Ecuador':'SOUTH AMERICA','Venezuela':'SOUTH AMERICA','Uruguay':'SOUTH AMERICA','Paraguay':'SOUTH AMERICA','Bolivia':'SOUTH AMERICA','Suriname':'SOUTH AMERICA','Guyana':'SOUTH AMERICA','French Guiana':'SOUTH AMERICA',
      'Germany':'EUROPE','UK':'EUROPE','France':'EUROPE','Italy':'EUROPE','Spain':'EUROPE','Netherlands':'EUROPE','Poland':'EUROPE','Belgium':'EUROPE','Sweden':'EUROPE','Switzerland':'EUROPE','Greece':'EUROPE','Portugal':'EUROPE','Czech Republic':'EUROPE','Romania':'EUROPE','Hungary':'EUROPE','Bulgaria':'EUROPE','Croatia':'EUROPE','Serbia':'EUROPE','Slovakia':'EUROPE','Slovenia':'EUROPE','Austria':'EUROPE','Denmark':'EUROPE','Norway':'EUROPE','Finland':'EUROPE','Ireland':'EUROPE','Cyprus':'EUROPE','Albania':'EUROPE','Bosnia':'EUROPE','Macedonia':'EUROPE','Montenegro':'EUROPE','Kosovo':'EUROPE','Iceland':'EUROPE','Luxembourg':'EUROPE','Malta':'EUROPE','Monaco':'EUROPE','Andorra':'EUROPE','Liechtenstein':'EUROPE','San Marino':'EUROPE','Vatican':'EUROPE','Jersey':'EUROPE','Guernsey':'EUROPE','Isle of Man':'EUROPE','Faroe Islands':'EUROPE','Greenland':'EUROPE','Svalbard':'EUROPE','Ukraine':'EUROPE','Lithuania':'EUROPE','Latvia':'EUROPE','Estonia':'EUROPE','Moldova':'EUROPE','Belarus':'EUROPE',
      'China':'ASIA','India':'ASIA','Japan':'ASIA','Korea':'ASIA','South Korea':'ASIA','Indonesia':'ASIA','Thailand':'ASIA','Vietnam':'ASIA','Philippines':'ASIA','Malaysia':'ASIA','Singapore':'ASIA','Pakistan':'ASIA','Bangladesh':'ASIA','Myanmar':'ASIA','Cambodia':'ASIA','Laos':'ASIA','Nepal':'ASIA','Sri Lanka':'ASIA','Afghanistan':'ASIA','Iraq':'ASIA','Iran':'ASIA','Israel':'ASIA','Jordan':'ASIA','Lebanon':'ASIA','Kuwait':'ASIA','Qatar':'ASIA','Oman':'ASIA','Bahrain':'ASIA','Yemen':'ASIA','Syria':'ASIA','Saudi Arabia':'ASIA','UAE':'ASIA','Turkey':'ASIA','Kazakhstan':'ASIA','Uzbekistan':'ASIA','Kyrgyzstan':'ASIA','Tajikistan':'ASIA','Turkmenistan':'ASIA','Azerbaijan':'ASIA','Armenia':'ASIA','Georgia':'ASIA','Mongolia':'ASIA','North Korea':'ASIA','Taiwan':'ASIA','Hong Kong':'ASIA','Macau':'ASIA','Brunei':'ASIA','East Timor':'ASIA','Bhutan':'ASIA','Maldives':'ASIA',
      'South Africa':'AFRICA','Egypt':'AFRICA','Nigeria':'AFRICA','Morocco':'AFRICA','Algeria':'AFRICA','Tunisia':'AFRICA','Libya':'AFRICA','Sudan':'AFRICA','Ethiopia':'AFRICA','Kenya':'AFRICA','Tanzania':'AFRICA','Uganda':'AFRICA','Ghana':'AFRICA','Ivory Coast':'AFRICA','Senegal':'AFRICA','Cameroon':'AFRICA','Angola':'AFRICA','Mozambique':'AFRICA','Madagascar':'AFRICA','Zimbabwe':'AFRICA','Zambia':'AFRICA','Malawi':'AFRICA','Rwanda':'AFRICA','Burundi':'AFRICA','Somalia':'AFRICA','Djibouti':'AFRICA','Eritrea':'AFRICA','Mauritania':'AFRICA','Mali':'AFRICA','Burkina Faso':'AFRICA','Niger':'AFRICA','Chad':'AFRICA','Central African Republic':'AFRICA','Congo':'AFRICA','DR Congo':'AFRICA','Gabon':'AFRICA','Equatorial Guinea':'AFRICA','Sao Tome':'AFRICA','Guinea':'AFRICA','Sierra Leone':'AFRICA','Liberia':'AFRICA','Togo':'AFRICA','Benin':'AFRICA','Mauritius':'AFRICA','Seychelles':'AFRICA','Comoros':'AFRICA','Cape Verde':'AFRICA','Guinea-Bissau':'AFRICA','Gambia':'AFRICA','Lesotho':'AFRICA','Swaziland':'AFRICA','Botswana':'AFRICA','Namibia':'AFRICA',
      'Australia':'OCEANIA','New Zealand':'OCEANIA','Papua New Guinea':'OCEANIA','Fiji':'OCEANIA','Solomon Islands':'OCEANIA','Vanuatu':'OCEANIA','Samoa':'OCEANIA','Tonga':'OCEANIA','Palau':'OCEANIA','Micronesia':'OCEANIA','Marshall Islands':'OCEANIA','Norfolk Island':'OCEANIA','Christmas Island':'OCEANIA','Cocos Islands':'OCEANIA',
      'Russia':'RUSSIA & CIS'
    };

    const getContinent = (c)=> countryToContinent[c] || 'OTHER';

    // ---------- ìƒˆë¡œìš´ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ë³€í™”ëŸ‰ì— ë”°ë¼ ë³´ê°„) ----------
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }
    
    function rgbToHex(r, g, b) {
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    
    function interpolateColor(color1, color2, factor) {
      const rgb1 = hexToRgb(color1);
      const rgb2 = hexToRgb(color2);
      if (!rgb1 || !rgb2) return color1;
      
      const r = Math.round(rgb1.r + (rgb2.r - rgb1.r) * factor);
      const g = Math.round(rgb1.g + (rgb2.g - rgb1.g) * factor);
      const b = Math.round(rgb1.b + (rgb2.b - rgb1.b) * factor);
      
      return rgbToHex(r, g, b);
    }
    
    function colorFromChange(change, intensity = 1) {
      // ìƒ‰ìƒ ì •ì˜
      const colors = {
        pos3: '#30cc5a',  // +3%
        pos2: '#2f9e4f',  // +2%
        pos1: '#3e7c55',  // +1%
        zero: '#414554',  // 0%
        neg1: '#8b444e',  // -1%
        neg2: '#bf4045',  // -2%
        neg3: '#f63538'   // -3%
      };
      
      // ë³€í™”ìœ¨ì— ë”°ë¼ ìƒ‰ìƒ ë³´ê°„
      if (change >= 3) {
        return colors.pos3;
      } else if (change >= 2) {
        const factor = (change - 2) / 1; // 2~3 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.pos2, colors.pos3, factor);
      } else if (change >= 1) {
        const factor = (change - 1) / 1; // 1~2 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.pos1, colors.pos2, factor);
      } else if (change > 0) {
        const factor = change / 1; // 0~1 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.zero, colors.pos1, factor);
      } else if (change === 0 || (change > -0.5 && change < 0.5)) {
        return colors.zero;
      } else if (change > -1) {
        const factor = Math.abs(change) / 1; // 0~1 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.zero, colors.neg1, factor);
      } else if (change > -2) {
        const factor = (Math.abs(change) - 1) / 1; // 1~2 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.neg1, colors.neg2, factor);
      } else if (change > -3) {
        const factor = (Math.abs(change) - 2) / 1; // 2~3 ì‚¬ì´ì˜ ë¹„ìœ¨
        return interpolateColor(colors.neg2, colors.neg3, factor);
      } else {
        return colors.neg3;
      }
    }

    // ---------- Sample data ----------
    function generateSampleData(){
      const countries = [];
      const names=['Vatican','Saint Pierre and Miquelon','Montserrat','ç¦å…‹å…°ç¾¤å²›','San Marino','Isle of Man','Niue','Cuba','Faroe Islands','Dutch Caribbean','Jersey','Bermuda','Sao Tome and Principe','Gibraltar','Andorra','Liechtenstein','Guinea-Bissau','Turks and Caicos Islands','Saint Martin','Sint Maarten','Anguilla','Central Africa','Equatorial Guinea','æ ¹è¥¿å²›','Aruba','Burundi','United States Virgin Islands','Saint Kitts and Nevis','Nauru','Bahamas','Cayman Islands','Lesotho','Northern Mariana Islands','Cape Verde','Guadeloupe','Palau','Antigua and Barbuda','Swaziland','Monaco','other','Martinique','Iceland','Cook Islands','Reunion','Liberia','New Caledonia','Gambia','Sierra Leone','Guinea','EU','French Guiana','Rwanda','Grenada','Togo','Greenland','Benin','Haiti','Angola','South Sudan','Mozambique','Saint Vincent and the Grenadines','Macao','Malta','Namibia','Burkina Faso','Gabon','Barbados','Guam','Seychelles','Djibouti','Marshall Islands','Mali','Cameroon','Belize','Botswana','Trinidad and Tobago','Zimbabwe','Niger','Estonia','Malawi','Papua New Guinea','Puerto Rico','Fiji Islands','Zambia','Panama','CÃ´te dIvoire','Senegal','Federated States of Micronesia','Luxembourg','Costa Rica','Slovenia','Ghana','Nicaragua','Bolivia','El Salvador','Paraguay','Uganda','Curacao','Uruguay','Korea','French Polynesia','Japan','Latvia','Honduras','Ireland','Surinam','Tonga','Solomon Islands','Montenegro','Denmark','Portugal','Dominica','Norway','Brunei','Croatia','Cyprus','Tunisia','Slovakia','Lithuania','Guatemala','Jamaica','Macedonia','Laos','new Zealand','Ecuador','Maldives','Venezuela','Peru','Tanzania','Chad','Guyana','Finland','Mauritania','Nigeria','Switzerland','Madagascar','China','Belgium','Bosnia and Herzegovina','Bahrain','Austria','East Timor','Albania','Bhutan','Colombia','Chile','Greece','Hungary','Sweden','Czech','Argentina','Tajikistan','Serbia','Sri Lanka','Spain','Moldova','Kenya','Poland','Ethiopia','Italy','Sudan','Australia','Mauritius','Armenia','South Africa','Kuwait','Oman','Qatar','Cambodia','Bulgaria','Iran','Morocco','Kyrgyzstan','Mongolia','Canada','Romania','Georgia','Belarus','Netherlands','Taiwan','Somalia','Israel','Turkmenistan','Mexico','Singapore','Kazakhstan','Brazil','Syria','United Arab Emirates','Palestine','United Kingdom','Afghanistan','Jordan','Yemen','France','Algeria','Undefined','Nepal','Lebanon','Bengal','Philippines','Azerbaijan','Libya','Hong Kong','Thailand','Malaysia','Myanmar','Ukraine','Vietnam','Germany','United States','Saudi Arabia','Uzbekistan','Indonesia','Egypt','Russia','Pakistan','Iraq','Turkey'];
      let seed=12345; function rnd(){ seed=(seed*9301+49297)%233280; return seed/233280; }
      
      // 7ì¼ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
      const allDates = [];
      const today = new Date();
      for(let d=6; d>=0; d--){
        const date = new Date(today);
        date.setDate(date.getDate() - d);
        allDates.push(`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`);
      }
      
      const trafficByDate = {};
      allDates.forEach(date => { trafficByDate[date] = []; }); // ëª¨ë“  ë‚ ì§œ ì´ˆê¸°í™”
      
      for(let i=0;i<250;i++){
        const name = i<names.length?names[i]:`Country${i+1}`;
        countries.push(name);
        const base=500000*Math.pow(0.92,i);
        const v=base*0.1*(rnd()-0.5);
        let prev=Math.max(1000,Math.round(base+v));
        
        // ê° ë‚ ì§œë³„ íŠ¸ë˜í”½ ìƒì„±
        allDates.forEach((date, idx) => {
          if(idx === 0){
            trafficByDate[date].push(prev);
          } else {
            prev = Math.round(prev*(1+(rnd()*0.1-0.05)));
            trafficByDate[date].push(prev);
          }
        });
      }
      
      const lastDate = allDates[allDates.length - 1];
      return {Country:countries, allDates:allDates, trafficByDate:trafficByDate, lastDate:lastDate};
    }

    const sampleData = generateSampleData();
    let currentData = sampleData;
    let rawCsvRows = null; // ì›ë³¸ CSV ë°ì´í„° ì €ì¥

    // ---------- CSV load ----------
    document.getElementById('btnLoad').addEventListener('click', ()=>{
      const f=document.getElementById('csvFile').files[0];
      if(!f){ alert('Please select a file.'); return; }
      Papa.parse(f,{header:true,skipEmptyLines:true,
        complete:({data})=>{ 
          rawCsvRows = data; // ì›ë³¸ ë°ì´í„° ì €ì¥
          
          // ì›” ëª©ë¡ ì¶”ì¶œ ë° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
          const months = extractMonthsFromCSV(data);
          updateMonthSelects(months);
          
          const p=processData(data); 
          if(p){ 
            currentData=p; 
            document.getElementById('status').textContent='CSV Loaded'; 
            createTreemap(currentData);
            // Update other tabs if they are active
            if(document.getElementById('tab-risers-fallers').classList.contains('active')){
              updateRisersFallers(currentData);
            }
            if(document.getElementById('tab-country-detail').classList.contains('active')){
              updateCountrySelect(currentData);
            }
            if(document.getElementById('tab-news').classList.contains('active')){
              loadNewsFromCSV();
            }
          } 
        },
        error:(e)=> alert('Error reading CSV: '+e)
      });
    });
    
    // ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©
    document.getElementById('btnApplyDateRange').addEventListener('click', ()=>{
      if(!rawCsvRows || rawCsvRows.length === 0){
        console.log('No CSV data');
        return;
      }
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if(!startDate || !endDate){
        console.log('No date range set');
        return;
      }
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999); // ì¢…ë£Œì¼ í¬í•¨
      
      if(start > end){
        console.log('Invalid date range');
        return;
      }
      
      console.log('Applying date filter:', startDate, '~', endDate);
      
      // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
      const firstRow = rawCsvRows[0] || {};
      const allKeys = Object.keys(firstRow);
      const findColumn = (keys, possibleNames) => {
        const lowerKeys = keys.map(k => k.toLowerCase());
        for(const name of possibleNames){
          const lowerName = name.toLowerCase();
          const idx = lowerKeys.indexOf(lowerName);
          if(idx !== -1) return keys[idx];
        }
        return null;
      };
      
      const dateCol = findColumn(allKeys, ['Date', 'date', 'ë‚ ì§œ', 'Date']);
      
      if(!dateCol){
        alert('Date column not found. Date range filter only works with Date,Country,Traffic format.');
        return;
      }
      
      // ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜
      const normalizeDate = (dateStr) => {
        let normalized = dateStr.toString().trim();
        normalized = normalized.replace(/\./g, '-').replace(/\s+/g, '');
        normalized = normalized.replace(/-+/g, '-');
        normalized = normalized.replace(/^-+|-+$/g, '');
        
        const parts = normalized.split('-');
        if(parts.length >= 3){
          const year = parseInt(parts[0]);
          const month = parseInt(parts[1]);
          const day = parseInt(parts[2]);
          if(!isNaN(year) && !isNaN(month) && !isNaN(day)){
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          }
        }
        return normalized;
      };
      
      // ë‚ ì§œ ë²”ìœ„ ë‚´ ë°ì´í„°ë§Œ í•„í„°ë§
      const filteredRows = rawCsvRows.filter(r => {
        if(!r[dateCol]) return false;
        const dateStr = normalizeDate(r[dateCol]);
        const rowDate = new Date(dateStr);
        if(isNaN(rowDate)) return false;
        return rowDate >= start && rowDate <= end;
      });
      
      if(filteredRows.length === 0){
        alert('No data found in the selected date range.');
        return;
      }
      
      const p = processData(filteredRows);
      if(p){
        currentData = p;
        document.getElementById('status').textContent = `CSV Loaded (${filteredRows.length} rows, ${startDate} ~ ${endDate})`;
        
        // Date Range í‘œì‹œ ì—…ë°ì´íŠ¸
        const indicator = document.getElementById('dateRangeIndicator');
        const rangeText = document.getElementById('dateRangeText');
        if(indicator && rangeText){
          const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
          rangeText.textContent = `${startDate} ~ ${endDate} (${daysDiff}ì¼)`;
          indicator.style.display = 'inline-block';
        }
        
        createTreemap(currentData);
        // Update other tabs if they are active
        if(document.getElementById('tab-risers-fallers').classList.contains('active')){
          updateRisersFallers(currentData);
        }
        if(document.getElementById('tab-country-detail').classList.contains('active')){
          updateCountrySelect(currentData);
        }
        if(document.getElementById('tab-news').classList.contains('active')){
          loadNewsFromCSV();
        }
      }
    });
    
    // ë‚ ì§œ ë²”ìœ„ í•„í„° ì´ˆê¸°í™”
    document.getElementById('btnClearDateRange').addEventListener('click', ()=>{
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      
      // Date Range í‘œì‹œ ìˆ¨ê¸°ê¸°
      const indicator = document.getElementById('dateRangeIndicator');
      if(indicator) indicator.style.display = 'none';
      
      if(rawCsvRows && rawCsvRows.length > 0){
        const p = processData(rawCsvRows);
        if(p){
          currentData = p;
          document.getElementById('status').textContent = 'CSV Loaded (All data)';
          createTreemap(currentData);
          // Update other tabs if they are active
          if(document.getElementById('tab-risers-fallers').classList.contains('active')){
            updateRisersFallers(currentData);
          }
          if(document.getElementById('tab-country-detail').classList.contains('active')){
            updateCountrySelect(currentData);
          }
        }
      }
    });

    // ========== ì›”ë³„ ì„ íƒ ê¸°ëŠ¥ ==========
    let availableMonths = []; // ì‚¬ìš© ê°€ëŠ¥í•œ ì›” ëª©ë¡
    
    // CSVì—ì„œ ì›” ëª©ë¡ ì¶”ì¶œ
    function extractMonthsFromCSV(rows) {
      const monthSet = new Set();
      const firstRow = rows[0] || {};
      const allKeys = Object.keys(firstRow);
      
      const findColumn = (keys, possibleNames) => {
        const lowerKeys = keys.map(k => k.toLowerCase());
        for(const name of possibleNames){
          const lowerName = name.toLowerCase();
          const idx = lowerKeys.indexOf(lowerName);
          if(idx !== -1) return keys[idx];
        }
        return null;
      };
      
      const dateCol = findColumn(allKeys, ['Date', 'date', 'ë‚ ì§œ']);
      if(!dateCol) return [];
      
      const normalizeDate = (dateStr) => {
        let normalized = dateStr.toString().trim();
        normalized = normalized.replace(/\./g, '-').replace(/\s+/g, '');
        normalized = normalized.replace(/-+/g, '-');
        normalized = normalized.replace(/^-+|-+$/g, '');
        return normalized;
      };
      
      rows.forEach(r => {
        if(r[dateCol]){
          const dateStr = normalizeDate(r[dateCol]);
          const parts = dateStr.split('-');
          if(parts.length >= 2){
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            if(!isNaN(year) && !isNaN(month) && year > 2000){
              monthSet.add(`${year}-${String(month).padStart(2, '0')}`);
            }
          }
        }
      });
      
      // ì›” ëª©ë¡ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
      return Array.from(monthSet).sort().reverse();
    }
    
    // ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateMonthSelects(months) {
      availableMonths = months;
      const monthSelect = document.getElementById('monthSelect');
      const compareMonthSelect = document.getElementById('compareMonthSelect');
      
      // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²«ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
      while(monthSelect.options.length > 1) monthSelect.remove(1);
      while(compareMonthSelect.options.length > 1) compareMonthSelect.remove(1);
      
      // ì›” ì˜µì…˜ ì¶”ê°€
      months.forEach(month => {
        const [year, mon] = month.split('-');
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        const displayText = `${year}ë…„ ${monthNames[parseInt(mon) - 1]}`;
        
        const opt1 = new Option(displayText, month);
        const opt2 = new Option(displayText, month);
        monthSelect.add(opt1);
        compareMonthSelect.add(opt2);
      });
    }
    
    // ì›”ì˜ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ë°˜í™˜
    function getMonthDateRange(monthStr) {
      const [year, month] = monthStr.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0); // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ 
      
      const formatDate = (d) => {
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };
      
      return {
        start: formatDate(startDate),
        end: formatDate(endDate)
      };
    }
    
    // ì›”ë³„ í•„í„° ì ìš©
    document.getElementById('btnApplyMonth').addEventListener('click', () => {
      if(!rawCsvRows || rawCsvRows.length === 0){
        alert('CSV ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const selectedMonth = document.getElementById('monthSelect').value;
      const compareMonth = document.getElementById('compareMonthSelect').value;
      
      if(!selectedMonth){
        alert('ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const firstRow = rawCsvRows[0] || {};
      const allKeys = Object.keys(firstRow);
      const findColumn = (keys, possibleNames) => {
        const lowerKeys = keys.map(k => k.toLowerCase());
        for(const name of possibleNames){
          const lowerName = name.toLowerCase();
          const idx = lowerKeys.indexOf(lowerName);
          if(idx !== -1) return keys[idx];
        }
        return null;
      };
      
      const dateCol = findColumn(allKeys, ['Date', 'date', 'ë‚ ì§œ']);
      if(!dateCol){
        alert('Date ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const normalizeDate = (dateStr) => {
        let normalized = dateStr.toString().trim();
        normalized = normalized.replace(/\./g, '-').replace(/\s+/g, '');
        normalized = normalized.replace(/-+/g, '-');
        normalized = normalized.replace(/^-+|-+$/g, '');
        return normalized;
      };
      
      // ì„ íƒëœ ì›”ì˜ ë°ì´í„° í•„í„°ë§
      const selectedRange = getMonthDateRange(selectedMonth);
      const selectedStart = new Date(selectedRange.start);
      const selectedEnd = new Date(selectedRange.end);
      selectedEnd.setHours(23, 59, 59, 999);
      
      let filteredRows = rawCsvRows.filter(r => {
        if(!r[dateCol]) return false;
        const dateStr = normalizeDate(r[dateCol]);
        const rowDate = new Date(dateStr);
        if(isNaN(rowDate)) return false;
        return rowDate >= selectedStart && rowDate <= selectedEnd;
      });
      
      // ë¹„êµ ì›”ì´ ì„ íƒëœ ê²½ìš° í•´ë‹¹ ë°ì´í„°ë„ í¬í•¨
      if(compareMonth && compareMonth !== selectedMonth){
        const compareRange = getMonthDateRange(compareMonth);
        const compareStart = new Date(compareRange.start);
        const compareEnd = new Date(compareRange.end);
        compareEnd.setHours(23, 59, 59, 999);
        
        const compareRows = rawCsvRows.filter(r => {
          if(!r[dateCol]) return false;
          const dateStr = normalizeDate(r[dateCol]);
          const rowDate = new Date(dateStr);
          if(isNaN(rowDate)) return false;
          return rowDate >= compareStart && rowDate <= compareEnd;
        });
        
        filteredRows = [...filteredRows, ...compareRows];
      }
      
      if(filteredRows.length === 0){
        alert('ì„ íƒí•œ ì›”ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const p = processData(filteredRows);
      if(p){
        currentData = p;
        
        // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const [year, mon] = selectedMonth.split('-');
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        let statusText = `${year}ë…„ ${monthNames[parseInt(mon) - 1]}`;
        
        if(compareMonth && compareMonth !== selectedMonth){
          const [cYear, cMon] = compareMonth.split('-');
          statusText += ` vs ${cYear}ë…„ ${monthNames[parseInt(cMon) - 1]}`;
        }
        
        document.getElementById('status').textContent = `ì›”ë³„ ë°ì´í„°: ${statusText} (${filteredRows.length} rows)`;
        
        // ì›”ë³„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const indicator = document.getElementById('monthIndicator');
        const monthText = document.getElementById('monthText');
        if(indicator && monthText){
          monthText.textContent = statusText;
          indicator.style.display = 'inline-block';
        }
        
        // Date Range í‘œì‹œëŠ” ìˆ¨ê¹€
        document.getElementById('dateRangeIndicator').style.display = 'none';
        
        createTreemap(currentData);
        
        if(document.getElementById('tab-risers-fallers').classList.contains('active')){
          updateRisersFallers(currentData);
        }
        if(document.getElementById('tab-country-detail').classList.contains('active')){
          updateCountrySelect(currentData);
        }
        if(document.getElementById('tab-news').classList.contains('active')){
          loadNewsFromCSV();
        }
      }
    });
    
    // ì›”ë³„ í•„í„° ì´ˆê¸°í™”
    document.getElementById('btnClearMonth').addEventListener('click', () => {
      document.getElementById('monthSelect').value = '';
      document.getElementById('compareMonthSelect').value = '';
      
      const indicator = document.getElementById('monthIndicator');
      if(indicator) indicator.style.display = 'none';
      
      if(rawCsvRows && rawCsvRows.length > 0){
        const p = processData(rawCsvRows);
        if(p){
          currentData = p;
          document.getElementById('status').textContent = 'CSV Loaded (All data)';
          createTreemap(currentData);
          
          if(document.getElementById('tab-risers-fallers').classList.contains('active')){
            updateRisersFallers(currentData);
          }
          if(document.getElementById('tab-country-detail').classList.contains('active')){
            updateCountrySelect(currentData);
          }
        }
      }
    });
    // ========== ì›”ë³„ ì„ íƒ ê¸°ëŠ¥ ë ==========

    function processData(rows){
      try{
        // Date,Country,Traffic (long format) - ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ì°¾ê¸°
        // ë‚ ì§œê°€ ì¤‘êµ¬ë‚œë°©ìœ¼ë¡œ ìˆì–´ë„ ë‚˜ë¼ë³„ë¡œ í”¼ë²—í•˜ì—¬ ì²˜ë¦¬
        const firstRow = rows[0] || {};
        const allKeys = Object.keys(firstRow);
        
        // ì»¬ëŸ¼ëª… ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
        const findColumn = (keys, possibleNames) => {
          const lowerKeys = keys.map(k => k.toLowerCase());
          for(const name of possibleNames){
            const lowerName = name.toLowerCase();
            const idx = lowerKeys.indexOf(lowerName);
            if(idx !== -1) return keys[idx];
          }
          return null;
        };
        
        const dateCol = findColumn(allKeys, ['Date', 'date', 'ë‚ ì§œ', 'Date']);
        const countryCol = findColumn(allKeys, ['Country', 'country', 'êµ­ê°€', 'Country']);
        const trafficCol = findColumn(allKeys, ['Traffic', 'traffic', 'íŠ¸ë˜í”½', 'DAU', 'dau', 'Traffic']);
        
        if(dateCol && countryCol && trafficCol){
          
          // êµ­ê°€ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
          const countryDataMap = {};
          
          // ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜
          const normalizeDate = (dateStr) => {
            let normalized = dateStr.toString().trim();
            normalized = normalized.replace(/\./g, '-').replace(/\s+/g, '');
            normalized = normalized.replace(/-+/g, '-');
            normalized = normalized.replace(/^-+|-+$/g, '');
            
            const parts = normalized.split('-');
            if(parts.length >= 3){
              const year = parseInt(parts[0]);
              const month = parseInt(parts[1]);
              const day = parseInt(parts[2]);
              if(!isNaN(year) && !isNaN(month) && !isNaN(day)){
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              }
            }
            return normalized;
          };
          
          rows.forEach(r=>{
            if(r[dateCol] && r[countryCol] && r[trafficCol]){
              const dateStr = normalizeDate(r[dateCol]);
              const country = r[countryCol].toString().trim();
              const traffic = +r[trafficCol];
              
              if(!countryDataMap[country]) countryDataMap[country] = {};
              countryDataMap[country][dateStr] = traffic;
            }
          });
          
          // ê° êµ­ê°€ë³„ë¡œ ë‚ ì§œ ì •ë ¬í•˜ê³  ëª¨ë“  ë‚ ì§œ ë°ì´í„° ì‚¬ìš©
          const countries = Object.keys(countryDataMap);
          const c = [];
          const allDates = new Set(); // ëª¨ë“  ë‚ ì§œ ìˆ˜ì§‘
          
          countries.forEach(country => {
            const dates = Object.keys(countryDataMap[country]).sort((a,b)=>{
              const dateA = new Date(a);
              const dateB = new Date(b);
              if(!isNaN(dateA) && !isNaN(dateB)) return dateA - dateB;
              return a.localeCompare(b);
            });
            
            dates.forEach(d => allDates.add(d));
            
            if(dates.length < 2){
              // ìµœì†Œ 2ì¼ ë°ì´í„° í•„ìš” (DoD ê³„ì‚°ì„ ìœ„í•´)
              return; // ì´ êµ­ê°€ëŠ” ìŠ¤í‚µ
            }
            
            c.push(country);
          });
          
          // ëª¨ë“  ë‚ ì§œ ì •ë ¬
          const sortedDates = Array.from(allDates).sort((a,b)=>{
            const dateA = new Date(a);
            const dateB = new Date(b);
            if(!isNaN(dateA) && !isNaN(dateB)) return dateA - dateB;
            return a.localeCompare(b);
          });
          
          // ë‚ ì§œë³„ íŠ¸ë˜í”½ ë°ì´í„° êµ¬ì„±: trafficByDate[date][countryIndex] = traffic
          const trafficByDate = {};
          sortedDates.forEach(date => {
            trafficByDate[date] = [];
            c.forEach(country => {
              trafficByDate[date].push(countryDataMap[country][date] || 0);
            });
          });
          
          const lastDate = sortedDates.length > 0 ? sortedDates[sortedDates.length - 1] : null;
          
          if(!c.length){ alert('No valid data found. Need at least 2 days of data for each country.'); return null; }
          // countryDataMapì„ í¬í•¨ì‹œì¼œ ë‚˜ì¤‘ì— êµ­ê°€ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•¨
          return {Country:c, allDates:sortedDates, trafficByDate:trafficByDate, lastDate:lastDate, countryDataMap:countryDataMap};
        }
        
        alert('Unsupported CSV format. Required: Date,Country,Traffic (or ë‚ ì§œ,êµ­ê°€,íŠ¸ë˜í”½)\në‚ ì§œëŠ” ì¤‘êµ¬ë‚œë°©ìœ¼ë¡œ ìˆì–´ë„ ë‚˜ë¼ë³„ë¡œ ìë™ í”¼ë²—í•˜ì—¬ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
        return null;
      }catch(e){ alert('Error processing data: '+e); return null; }
    }

    // ---------- Stats ----------
    function calculateStats(data){
      const total=[], change=[], lastDayTraffic=[];
      const {Country, allDates, trafficByDate} = data;
      const comparisonType = document.getElementById('comparisonType').value || 'DoD';
      
      // ë§ˆì§€ë§‰ ë‚ ì§œ ì°¾ê¸°
      const lastDate = allDates.length > 0 ? new Date(allDates[allDates.length - 1]) : null;
      
      for(let i=0;i<Country.length;i++){
        // ë§ˆì§€ë§‰ ë‚  íŠ¸ë˜í”½ (WoW/MoM/QoQì—ì„œ ê¸°ê°„ í•©ê³„ë¡œ ë³€ê²½ë  ìˆ˜ ìˆìŒ)
        let lastDayValue = (lastDate && trafficByDate[allDates[allDates.length - 1]] && trafficByDate[allDates[allDates.length - 1]][i]) || 0;
        lastDayTraffic.push(lastDayValue);
        
        // ë¹„êµ ê¸°ì¤€ì¼ ì°¾ê¸°
        let compareDate = null;
        let compareValue = null;
        
        if(lastDate && !isNaN(lastDate)){
          const compareDateObj = new Date(lastDate);
          
          switch(comparisonType){
            case 'DoD':
              // Day over Day: ì „ì¼ ëŒ€ë¹„ (ë§ˆì§€ë§‰ ë‚  vs ì „ë‚ )
              if(allDates.length > 1){
                const prevDayDate = allDates[allDates.length - 2]; // ì „ë‚ 
                if(trafficByDate[prevDayDate] && trafficByDate[prevDayDate][i] !== undefined){
                  compareValue = trafficByDate[prevDayDate][i];
                }
              }
              break;
              
            case 'Period':
              // Period: ê¸°ê°„ ì „ì²´ ë³€í™” (ë§ˆì§€ë§‰ ë‚  vs ì²«ë‚ )
              if(allDates.length > 0){
                const firstDate = allDates[0];
                if(trafficByDate[firstDate] && trafficByDate[firstDate][i] !== undefined){
                  compareValue = trafficByDate[firstDate][i];
                }
              }
              break;
              
            case 'WoW':
              // Week over Week: ìµœê·¼ 7ì¼ í•©ê³„ vs ì´ì „ 7ì¼ í•©ê³„
              {
                const periodDays = 7;
                let currentSum = 0, prevSum = 0;
                const lastIdx = allDates.length - 1;
                
                // ìµœê·¼ 7ì¼ í•©ê³„
                for(let d = 0; d < periodDays && (lastIdx - d) >= 0; d++){
                  const dateKey = allDates[lastIdx - d];
                  if(trafficByDate[dateKey] && trafficByDate[dateKey][i] !== undefined){
                    currentSum += trafficByDate[dateKey][i];
                  }
                }
                
                // ì´ì „ 7ì¼ í•©ê³„
                for(let d = periodDays; d < periodDays * 2 && (lastIdx - d) >= 0; d++){
                  const dateKey = allDates[lastIdx - d];
                  if(trafficByDate[dateKey] && trafficByDate[dateKey][i] !== undefined){
                    prevSum += trafficByDate[dateKey][i];
                  }
                }
                
                if(prevSum > 0) compareValue = prevSum;
                lastDayValue = currentSum > 0 ? currentSum : lastDayValue;
              }
              break;
              
            case 'MoM':
              // Month over Month: ìµœê·¼ 30ì¼ í•©ê³„ vs ì´ì „ 30ì¼ í•©ê³„
              {
                const periodDays = 30;
                let currentSum = 0, prevSum = 0;
                const lastIdx = allDates.length - 1;
                
                // ìµœê·¼ 30ì¼ í•©ê³„
                for(let d = 0; d < periodDays && (lastIdx - d) >= 0; d++){
                  const dateKey = allDates[lastIdx - d];
                  if(trafficByDate[dateKey] && trafficByDate[dateKey][i] !== undefined){
                    currentSum += trafficByDate[dateKey][i];
                  }
                }
                
                // ì´ì „ 30ì¼ í•©ê³„
                for(let d = periodDays; d < periodDays * 2 && (lastIdx - d) >= 0; d++){
                  const dateKey = allDates[lastIdx - d];
                  if(trafficByDate[dateKey] && trafficByDate[dateKey][i] !== undefined){
                    prevSum += trafficByDate[dateKey][i];
                  }
                }
                
                if(prevSum > 0) compareValue = prevSum;
                lastDayValue = currentSum > 0 ? currentSum : lastDayValue;
              }
              break;
              
            case 'QoQ':
              // Quarter over Quarter: ìµœê·¼ 90ì¼ í•©ê³„ vs ì´ì „ 90ì¼ í•©ê³„
              {
                const periodDays = 90;
                let currentSum = 0, prevSum = 0;
                const lastIdx = allDates.length - 1;
                
                // ìµœê·¼ 90ì¼ í•©ê³„
                for(let d = 0; d < periodDays && (lastIdx - d) >= 0; d++){
                  const dateKey = allDates[lastIdx - d];
                  if(trafficByDate[dateKey] && trafficByDate[dateKey][i] !== undefined){
                    currentSum += trafficByDate[dateKey][i];
                  }
                }
                
                // ì´ì „ 90ì¼ í•©ê³„
                for(let d = periodDays; d < periodDays * 2 && (lastIdx - d) >= 0; d++){
                  const dateKey = allDates[lastIdx - d];
                  if(trafficByDate[dateKey] && trafficByDate[dateKey][i] !== undefined){
                    prevSum += trafficByDate[dateKey][i];
                  }
                }
                
                if(prevSum > 0) compareValue = prevSum;
                lastDayValue = currentSum > 0 ? currentSum : lastDayValue;
              }
              break;
              
            case 'YoY':
              // Year over Year: 1ë…„ ì „
              compareDateObj.setFullYear(compareDateObj.getFullYear() - 1);
              compareDate = `${compareDateObj.getFullYear()}-${String(compareDateObj.getMonth()+1).padStart(2,'0')}-${String(compareDateObj.getDate()).padStart(2,'0')}`;
              // ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸°
              const yoyDates = allDates.filter(d => {
                const dObj = new Date(d);
                const diff = Math.abs((dObj - compareDateObj) / (1000 * 60 * 60 * 24));
                return diff <= 7; // 7ì¼ ì´ë‚´ ì°¨ì´
              });
              if(yoyDates.length > 0){
                const closestDate = yoyDates.sort((a,b) => {
                  const aDiff = Math.abs((new Date(a) - compareDateObj) / (1000 * 60 * 60 * 24));
                  const bDiff = Math.abs((new Date(b) - compareDateObj) / (1000 * 60 * 60 * 24));
                  return aDiff - bDiff;
                })[0];
                if(trafficByDate[closestDate] && trafficByDate[closestDate][i] !== undefined){
                  compareValue = trafficByDate[closestDate][i];
                }
              }
              break;
          }
        }
        
        // ë³€í™”ìœ¨ ê³„ì‚°
        if(compareValue !== null && compareValue > 0 && lastDayValue > 0){
          change.push(((lastDayValue - compareValue) / compareValue) * 100);
        } else {
          change.push(0);
        }
        
        // totalì€ ë§ˆì§€ë§‰ ë‚  íŠ¸ë˜í”½ìœ¼ë¡œ ì„¤ì •
        total.push(lastDayValue);
      }
      const topN = +document.getElementById('topCount').value || 180;
      const sortBy = document.getElementById('sortBy').value || 'revenue';
      let idx;
      if(sortBy==='revenue'){
        idx=Array.from({length:data.Country.length},(_,i)=>i).sort((a,b)=> total[b]-total[a]).slice(0,topN);
      } else if(sortBy==='change_desc'){
        // + ë³€í™”ëŸ‰ í° ìˆœ (ë³€í™”ëŸ‰ ì ˆëŒ€ê°’ì´ í° ìˆœì„œëŒ€ë¡œ)
        idx=Array.from({length:data.Country.length},(_,i)=>i)
          .sort((a,b)=> Math.abs(change[b])-Math.abs(change[a])) // ì ˆëŒ€ê°’ ê¸°ì¤€ í° ìˆœì„œ
          .slice(0,topN);
      } else if(sortBy==='change_asc'){
        // - ë³€í™”ëŸ‰ í° ìˆœ (í•˜ë½í­ì´ í° ìˆœì„œëŒ€ë¡œ, ìŒìˆ˜ ì¤‘ ì ˆëŒ€ê°’ í° ìˆœ)
        idx=Array.from({length:data.Country.length},(_,i)=>i)
          .filter(i=> change[i] < 0) // ìŒìˆ˜ë§Œ í•„í„°ë§
          .sort((a,b)=> Math.abs(change[a])-Math.abs(change[b])) // ì ˆëŒ€ê°’ ê¸°ì¤€ í° ìˆœì„œ (í•˜ë½í­ í° ìˆœ)
          .slice(0,topN);
      }

      const topCountries=idx.map(i=>data.Country[i]);
      const topRevenue=idx.map(i=>total[i]);
      const topChange=idx.map(i=>change[i]);
      const totalSum=topRevenue.reduce((a,b)=>a+b,0);
      const avgChange=topChange.reduce((a,b)=>a+b,0)/topChange.length;
      
      // Max Increase/Decrease êµ­ê°€ ì°¾ê¸°
      const maxChangeIdx = topChange.indexOf(Math.max(...topChange));
      const minChangeIdx = topChange.indexOf(Math.min(...topChange));
      const maxChangeCountry = topCountries[maxChangeIdx] || '';
      const minChangeCountry = topCountries[minChangeIdx] || '';
      
      // Traffic Top 10 (ë§ˆì§€ë§‰ ë‚  íŠ¸ë˜í”½ ê¸°ì¤€) - countryDataMapì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
      const allCountries = data.Country;
      const lastDateKey = data.allDates[data.allDates.length - 1];
      
      // countryDataMapì—ì„œ ì§ì ‘ ë§ˆì§€ë§‰ ë‚  íŠ¸ë˜í”½ ê°€ì ¸ì˜¤ê¸°
      // ì¤‘ìš”: ë§ˆì§€ë§‰ ë‚ ì§œì— ë°ì´í„°ê°€ ìˆëŠ” êµ­ê°€ë§Œ í¬í•¨!
      const countryTrafficMap = {};
      allCountries.forEach((country, idx) => {
        if(data.countryDataMap && data.countryDataMap[country] && data.countryDataMap[country][lastDateKey] !== undefined) {
          // ë§ˆì§€ë§‰ ë‚ ì§œì— ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ í¬í•¨
          const trafficValue = Number(data.countryDataMap[country][lastDateKey]) || 0;
          if(trafficValue > 0) { // 0ë³´ë‹¤ í° ê²½ìš°ë§Œ
            countryTrafficMap[country] = {
              traffic: trafficValue,
              change: change[idx],
              index: idx
            };
          }
        }
      });
      
      // íŠ¸ë˜í”½ ê¸°ì¤€ Top 10 (ë§ˆì§€ë§‰ ë‚ ì§œì— ë°ì´í„°ê°€ ìˆëŠ” êµ­ê°€ë§Œ!)
      const trafficTop10 = Object.entries(countryTrafficMap)
        .sort((a, b) => b[1].traffic - a[1].traffic)
        .slice(0, 10)
        .map(([country, data]) => ({
          country: country,
          traffic: data.traffic,
          change: data.change
        }));
      
      // ë””ë²„ê¹… ë¡œê·¸
      console.log('=== Traffic Top 10 (Fixed v2) ===');
      console.log('Last date:', lastDateKey);
      console.log('Countries with data on last date:', Object.keys(countryTrafficMap).length);
      console.log('Top 10:', trafficTop10.map(t => `${t.country}: ${t.traffic.toLocaleString()}`));
      
      return {topCountries, topRevenue, topChange, totalSum, avgChange,
              maxChange:Math.max(...topChange), minChange:Math.min(...topChange),
              maxChangeCountry, minChangeCountry, trafficTop10};
    }

    // ---------- Render ----------
    const overlay=document.getElementById('loadingOverlay');
    ['topCount','sortBy','groupByContinent','comparisonType'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=> createTreemap(currentData));
    });

    function createTreemap(data){
      const overlay = document.getElementById('loadingOverlay');
      if(overlay) overlay.style.display='flex';
      setTimeout(()=>{
        const stats=calculateStats(data);
        const topN=+document.getElementById('topCount').value || 180;
        const groupBy=document.getElementById('groupByContinent').checked;
        const comparisonType = document.getElementById('comparisonType').value || 'DoD';
        
        // ë¹„êµ ê¸°ì¤€ ì •ë³´ ì—…ë°ì´íŠ¸
        const comparisonInfo = document.getElementById('comparisonInfo');
        const dataContextInfo = document.getElementById('dataContextInfo');
        const dataContextPeriod = document.getElementById('dataContextPeriod');
        const dataContextComparison = document.getElementById('dataContextComparison');
        const dataContextRows = document.getElementById('dataContextRows');
        
        if(data.allDates && data.allDates.length > 0){
          const lastDate = data.allDates[data.allDates.length - 1];
          const firstDate = data.allDates[0];
          const prevDate = data.allDates.length > 1 ? data.allDates[data.allDates.length - 2] : firstDate;
          
          const formatDate = (d) => {
            const date = new Date(d);
            return `${date.getMonth()+1}/${date.getDate()}`;
          };
          
          const formatDateFull = (d) => {
            const date = new Date(d);
            return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
          };
          
          let comparisonLabel = '';
          let compareFromDate = '';
          let compareToDate = formatDate(lastDate);
          
          switch(comparisonType){
            case 'DoD':
              comparisonLabel = 'ì „ì¼ ëŒ€ë¹„';
              compareFromDate = formatDate(prevDate);
              break;
            case 'WoW':
              comparisonLabel = 'ì£¼ê°„ í•©ê³„ (7ì¼)';
              const weekAgo = new Date(lastDate);
              weekAgo.setDate(weekAgo.getDate() - 7);
              compareFromDate = `ìµœê·¼7ì¼ vs ì´ì „7ì¼`;
              break;
            case 'MoM':
              comparisonLabel = 'ì›”ê°„ í•©ê³„ (30ì¼)';
              const monthAgo = new Date(lastDate);
              monthAgo.setMonth(monthAgo.getMonth() - 1);
              compareFromDate = `ìµœê·¼30ì¼ vs ì´ì „30ì¼`;
              break;
            case 'QoQ':
              comparisonLabel = 'ë¶„ê¸° í•©ê³„ (90ì¼)';
              compareFromDate = `ìµœê·¼90ì¼ vs ì´ì „90ì¼`;
              break;
            case 'YoY':
              comparisonLabel = 'ì „ë…„ ëŒ€ë¹„';
              const yearAgo = new Date(lastDate);
              yearAgo.setFullYear(yearAgo.getFullYear() - 1);
              compareFromDate = formatDate(yearAgo);
              break;
            case 'Period':
              comparisonLabel = 'ê¸°ê°„ ì „ì²´';
              compareFromDate = formatDate(firstDate);
              break;
          }
          
          // ì‘ì€ info í…ìŠ¤íŠ¸ (ë“œë¡­ë‹¤ìš´ ì˜†)
          if(comparisonInfo){
            comparisonInfo.textContent = `${compareFromDate} â†’ ${compareToDate}`;
          }
          
          // í° ë°ì´í„° ê¸°ì¤€ ë°•ìŠ¤
          if(dataContextInfo){
            dataContextInfo.style.display = 'block';
            
            // ë°ì´í„° ê¸°ê°„
            const daysDiff = data.allDates.length;
            dataContextPeriod.textContent = `${formatDateFull(firstDate)} ~ ${formatDateFull(lastDate)} (${daysDiff}ì¼)`;
            
            // ë³€í™”ìœ¨ ê¸°ì¤€
            dataContextComparison.innerHTML = `<span style="color:#2ed573">${comparisonLabel}</span> <span style="color:var(--muted);font-weight:400">(${compareFromDate} â†’ ${compareToDate})</span>`;
            
            // ë°ì´í„° ìˆ˜
            const totalCountries = data.Country ? data.Country.length : 0;
            dataContextRows.textContent = `${totalCountries}ê°œ êµ­ê°€`;
          }
        }

        // KPIs
        document.getElementById('stats').innerHTML = `
          <div class="stat-item"><div class="stat-label">Total Traffic</div><div class="stat-value">${(stats.totalSum/1e6).toFixed(2)}M</div></div>
          <div class="stat-item"><div class="stat-label">Avg Change</div><div class="stat-value ${stats.avgChange>=0?'positive':'negative'}">${stats.avgChange>=0?'+':''}${stats.avgChange.toFixed(2)}%</div></div>
          <div class="stat-item"><div class="stat-label">Max Increase</div><div class="stat-value positive">+${stats.maxChange.toFixed(2)}% <span style="font-size:14px;opacity:0.8">(${stats.maxChangeCountry})</span></div></div>
          <div class="stat-item"><div class="stat-label">Max Decrease</div><div class="stat-value negative">${stats.minChange.toFixed(2)}% <span style="font-size:14px;opacity:0.8">(${stats.minChangeCountry})</span></div></div>`;
        
        // Traffic Top 10 í‘œ ì œëª© ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ë‚ ì§œ í‘œì‹œ: ì—°ë„.ì›”.ì¼ í˜•ì‹)
        const top10Title = document.getElementById('trafficTop10Title');
        if(top10Title && data.lastDate){
          const lastDateObj = new Date(data.lastDate);
          if(!isNaN(lastDateObj)){
            const year = lastDateObj.getFullYear().toString().slice(-2); // ë§ˆì§€ë§‰ 2ìë¦¬
            const month = String(lastDateObj.getMonth() + 1).padStart(2, '0');
            const day = String(lastDateObj.getDate()).padStart(2, '0');
            top10Title.textContent = `Traffic Top 10 (${year}.${month}.${day} ê¸°ì¤€)`;
          } else {
            // ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ì¶”ì¶œ ì‹œë„
            const dateMatch = data.lastDate.match(/(\d{1,2})/);
            if(dateMatch){
              top10Title.textContent = `Traffic Top 10 (${dateMatch[1]}ì¼ ê¸°ì¤€)`;
            } else {
              top10Title.textContent = 'Traffic Top 10 (DoD ê¸°ì¤€)';
            }
          }
        } else if(top10Title){
          top10Title.textContent = 'Traffic Top 10 (DoD ê¸°ì¤€)';
        }
        
        // Traffic Top 10 í‘œ ì—…ë°ì´íŠ¸
        const top10Body = document.getElementById('trafficTop10Body');
        if(top10Body && stats.trafficTop10){
          top10Body.innerHTML = stats.trafficTop10.map((item, idx) => {
            const changeColor = item.change >= 0 ? '#00ff00' : '#ff4d4d';
            const changeSign = item.change >= 0 ? '+' : '';
            return `
              <tr style="border-bottom:1px solid var(--border);${idx % 2 === 0 ? 'background:rgba(255,255,255,0.02)' : ''}">
                <td style="padding:14px;font-size:16px;color:#fff;font-weight:600">${idx + 1}</td>
                <td style="padding:14px;font-size:16px;color:#fff;font-weight:600">${item.country}</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:#fff">${(item.traffic/1e6).toFixed(2)}M</td>
                <td style="padding:14px;text-align:right;font-size:16px;color:${changeColor};font-weight:600">${changeSign}${item.change.toFixed(2)}%</td>
              </tr>
            `;
          }).join('');
        }

        // Build treemap arrays
        let ids=[], labels=[], parents=[], values=[], colors=[], text=[], custom=[];

        if(groupBy){
          const groups={};
          stats.topCountries.forEach((c,i)=>{ const G=getContinent(c); (groups[G]||(groups[G]={c:[],v:[],chg:[]})).c.push(c); groups[G].v.push(stats.topRevenue[i]); groups[G].chg.push(stats.topChange[i]); });
          const continents=Object.keys(groups).sort((a,b)=> groups[b].v.reduce((x,y)=>x+y,0)-groups[a].v.reduce((x,y)=>x+y,0));

          continents.forEach(cont=>{
            const g=groups[cont];
            const total=g.v.reduce((a,b)=>a+b,0);
            const contId=`continent:${cont}`;
            // ëŒ€ë¥™ í…ìŠ¤íŠ¸ í¬ê²Œ (ë³¼ë“œì²´) - Finviz ìŠ¤íƒ€ì¼
            const continentTextShadow = 'text-shadow: 2px 2px 4px rgba(0,0,0,0.7), 0 0 6px rgba(0,0,0,0.6);';
            ids.push(contId); labels.push(cont); parents.push(''); values.push(total); colors.push('#262931'); text.push(`<b style="font-size:86.4px;font-weight:900;letter-spacing:2px;color:#FFFFFF;${continentTextShadow}">${cont}</b>`); custom.push([null,null,cont]);

            // thresholds for label density by share
            const small=0.010, medium=0.025;
            const maxAbsChange = g.chg.length > 0 ? Math.max(...g.chg.map(c => Math.abs(c))) : 1;
            // êµ­ê°€ë³„ ê¸€ì”¨ í¬ê¸° ê³ ì • (ëª¨ë“  êµ­ê°€ ë™ì¼)
            const countryFontSize = 20; // India í¬ê¸°ë¡œ ê³ ì •
            g.c.forEach((country,i)=>{
              const revenue=g.v[i];
              const change=g.chg[i];
              const share=revenue/total; // area fraction approx
              // ë³€í™”ëŸ‰ì— ë”°ë¥¸ ê°•ë„ ê³„ì‚°
              const changeIntensity = maxAbsChange > 0 ? Math.abs(change) / maxAbsChange : 0;
              // ë³€í™”ê°€ í´ìˆ˜ë¡ ë” ì§„í•œ ìƒ‰ìƒ
              const col=colorFromChange(change, changeIntensity);
              ids.push(`country:${cont}:${country}`);
              labels.push(country);
              parents.push(contId);
              values.push(revenue);
              colors.push(col);
              let t='';
              // ë³€í™”ëŸ‰ë§Œ í‘œì‹œ, ë³¼ë“œì²´, ëª…ì•” ì¶”ê°€
              const textShadow = 'text-shadow: 1px 1px 3px rgba(0,0,0,0.7), 0 0 4px rgba(0,0,0,0.5);';
              if(share>=small){
                t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b><br><b style="font-size:${Math.max(12,countryFontSize*0.75)}px;font-weight:bold;color:#FFFFFF;${textShadow}">${change>=0?'+':''}${change.toFixed(1)}%</b>`;
              }else{
                t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b>`;
              }
              text.push(t);
              custom.push([change, revenue, cont]);
            });
          });
                } else {
          const total = stats.topRevenue.reduce((a,b)=>a+b,0);
          const small=0.006;
          const maxAbsChange = stats.topChange.length > 0 ? Math.max(...stats.topChange.map(c => Math.abs(c))) : 1;
          // êµ­ê°€ë³„ ê¸€ì”¨ í¬ê¸° ê³ ì • (ëª¨ë“  êµ­ê°€ ë™ì¼)
          const countryFontSize = 20; // India í¬ê¸°ë¡œ ê³ ì •
          stats.topCountries.forEach((country,i)=>{
            const rev=stats.topRevenue[i]; const ch=stats.topChange[i]; const share=rev/total; const cont=getContinent(country);
            // ë³€í™”ëŸ‰ì— ë”°ë¥¸ ê°•ë„ ê³„ì‚°
            const changeIntensity = maxAbsChange > 0 ? Math.abs(ch) / maxAbsChange : 0;
            // ë³€í™”ê°€ í´ìˆ˜ë¡ ë” ì§„í•œ ìƒ‰ìƒ
            const col = colorFromChange(ch, changeIntensity);
            ids.push(`country::${country}`); labels.push(country); parents.push(''); values.push(rev); colors.push(col);
            let t='';
            // ë³€í™”ëŸ‰ë§Œ í‘œì‹œ, ë³¼ë“œì²´, ëª…ì•” ì¶”ê°€
            const textShadow = 'text-shadow: 1px 1px 3px rgba(0,0,0,0.9), 0 0 5px rgba(0,0,0,0.7);';
            if(share>=small) t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b><br><b style="font-size:${Math.max(12,countryFontSize*0.75)}px;font-weight:bold;color:#FFFFFF;${textShadow}">${ch>=0?'+':''}${ch.toFixed(1)}%</b>`;
            else t = `<b style="font-size:${countryFontSize}px;font-weight:bold;color:#FFFFFF;${textShadow}">${country}</b>`;
            text.push(t);
            custom.push([ch, rev, cont]);
          });
        }

        const height = 900; // fixed height for visual stability

        const trace={
          type:'treemap',
          ids, labels, parents, values,
          text, textinfo:'text', textposition:'middle center',
          marker:{ colors, line:{width:1, color:'#000000'}, depthfade:false },
          tiling:{ pad: 1 },
          branchvalues:'total', maxdepth: groupBy ? 2 : 1,
          hovertemplate:'<b>%{label}</b><br>Traffic: %{value:,.0f}<br>'+
                        'Change: %{customdata[0]:.2f}%<br>Sector: %{customdata[2]}<extra></extra>',
          customdata: custom,
          pathbar:{visible:false}
        };

        const layout={
          paper_bgcolor: '#262931',
          plot_bgcolor: '#262931',
          margin:{l:0,r:0,t:0,b:0}, height,
          font:{family:'Arial, Helvetica, sans-serif',size:11,color:'#FFFFFF'},
          hoverlabel:{bgcolor:'#161b22',bordercolor:'#30363d',font:{color:'#fff'}}
        };

        Plotly.newPlot('treemap',[trace],layout,{responsive:true}).then(()=>{ 
          if(overlay) overlay.style.display='none';
          
          // Treemap í´ë¦­ ì´ë²¤íŠ¸: êµ­ê°€ í´ë¦­ ì‹œ Country Detailë¡œ ì´ë™
          const treemapDiv = document.getElementById('treemap');
          treemapDiv.on('plotly_click', (data) => {
            if(data.points && data.points.length > 0){
              const point = data.points[0];
              const label = point.label;
              
              // êµ­ê°€ëª… ì¶”ì¶œ (ëŒ€ë¥™ì´ ì•„ë‹Œ ê²½ìš°ë§Œ)
              if(label && currentData && currentData.Country && currentData.Country.includes(label)){
                selectCountryFromExternal(label);
              }
            }
          });
        });
      }, 40);
    }

    // ---------- Tab Management ----------
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');
        
        // Remove active class from all buttons and contents
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked button and corresponding content
        button.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // News íƒ­ì—ì„œëŠ” Treemap í•„í„° ìˆ¨ê¸°ê¸°
        const treemapFilters = document.getElementById('treemapFilters');
        if(treemapFilters){
          treemapFilters.style.display = (tabName === 'news') ? 'none' : 'flex';
        }
        
        // Update content based on tab
        if(tabName === 'risers-fallers'){
          updateRisersFallers(currentData);
        } else if(tabName === 'country-detail'){
          updateCountrySelect(currentData);
        } else if(tabName === 'news'){
          loadNewsFromCSV();
        }
      });
    });

    // ---------- Risers/Fallers Tab ----------
    function updateRisersFallers(data){
      if(!data || !data.Country) return;
      
      const stats = calculateStats(data);
      const threshold = 5; // 5% ì´ìƒ
      
      // íŠ¸ë˜í”½ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: 50000)
      const trafficFilter = parseFloat(document.getElementById('risersFallersTrafficFilter')?.value || '50000');
      
      // ë¹„êµ ê¸°ì¤€ ë¼ë²¨ ì—…ë°ì´íŠ¸
      const comparisonType = document.getElementById('comparisonType')?.value || 'DoD';
      const comparisonLabels = {
        'DoD': 'DoD (ì „ì¼ ëŒ€ë¹„)',
        'WoW': 'WoW (7ì¼ í•©ê³„)',
        'MoM': 'MoM (30ì¼ í•©ê³„)',
        'QoQ': 'QoQ (90ì¼ í•©ê³„)',
        'YoY': 'YoY (ì „ë…„ ëŒ€ë¹„)',
        'Period': 'Period (ê¸°ê°„ ì „ì²´)'
      };
      const compLabel = comparisonLabels[comparisonType] || comparisonType;
      
      document.getElementById('risersTitle').innerHTML = `ğŸ“ˆ Risers <span style="font-size:12px;font-weight:normal">(${compLabel} 5%â†‘)</span>`;
      document.getElementById('fallersTitle').innerHTML = `ğŸ“‰ Fallers <span style="font-size:12px;font-weight:normal">(${compLabel} 5%â†“)</span>`;
      
      const risers = [];
      const fallers = [];
      
      for(let i = 0; i < stats.topCountries.length; i++){
        const change = stats.topChange[i];
        const country = stats.topCountries[i];
        const traffic = stats.topRevenue[i];
        
        // 5% ì´ìƒ ë³€í™” + íŠ¸ë˜í”½ í•„í„° ì¡°ê±´ ë§Œì¡±
        if(change >= threshold && traffic >= trafficFilter){
          risers.push({country, change, traffic});
        } else if(change <= -threshold && traffic >= trafficFilter){
          fallers.push({country, change, traffic});
        }
      }
      
      // Sort by absolute change
      risers.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
      fallers.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
      
      // Render Risers
      const risersList = document.getElementById('risersList');
      if(risers.length > 0){
        risersList.innerHTML = risers.map(item => `
          <div class="country-item" style="cursor:pointer" onclick="selectCountryFromExternal('${item.country}')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°">
            <div>
              <div class="country-name">${item.country}</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">${(item.traffic/1e6).toFixed(2)}M</div>
            </div>
            <div class="country-change positive">+${item.change.toFixed(2)}%</div>
          </div>
        `).join('');
      } else {
        risersList.innerHTML = `
          <div class="empty-state" style="padding:40px 20px">
            <div class="empty-state-icon">ğŸ“ˆ</div>
            <div>5% ì´ìƒ ìƒìŠ¹í•œ êµ­ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">(íŠ¸ë˜í”½ ${(trafficFilter/1000).toFixed(0)}K ì´ìƒ ì¡°ê±´ í¬í•¨)</div>
          </div>
        `;
      }
      
      // Render Fallers
      const fallersList = document.getElementById('fallersList');
      if(fallers.length > 0){
        fallersList.innerHTML = fallers.map(item => `
          <div class="country-item" style="cursor:pointer" onclick="selectCountryFromExternal('${item.country}')" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°">
            <div>
              <div class="country-name">${item.country}</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px">${(item.traffic/1e6).toFixed(2)}M</div>
            </div>
            <div class="country-change negative">${item.change.toFixed(2)}%</div>
          </div>
        `).join('');
      } else {
        fallersList.innerHTML = `
          <div class="empty-state" style="padding:40px 20px">
            <div class="empty-state-icon">ğŸ“‰</div>
            <div>5% ì´ìƒ í•˜ë½í•œ êµ­ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">(íŠ¸ë˜í”½ ${(trafficFilter/1000).toFixed(0)}K ì´ìƒ ì¡°ê±´ í¬í•¨)</div>
          </div>
        `;
      }
    }

    // íŠ¸ë˜í”½ í•„í„° ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
    document.getElementById('risersFallersTrafficFilter')?.addEventListener('input', () => {
      if(document.getElementById('tab-risers-fallers').classList.contains('active')){
        updateRisersFallers(currentData);
      }
    });

    // ---------- Country Detail Tab ----------
    let allCountriesList = []; // ê²€ìƒ‰ìš© êµ­ê°€ ëª©ë¡
    let countryTrafficMap = {}; // êµ­ê°€ë³„ íŠ¸ë˜í”½ ë§µ (ë¹ ë¥¸ ì„ íƒìš©)
    let top10Mode = 'lastDay'; // 'lastDay' or 'cumulative'
    
    // Top 10 ëª¨ë“œ ì „í™˜
    function setTop10Mode(mode) {
      top10Mode = mode;
      
      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      document.getElementById('top10LastDay').style.background = mode === 'lastDay' ? 'var(--accent)' : 'transparent';
      document.getElementById('top10LastDay').style.color = mode === 'lastDay' ? 'white' : 'var(--text)';
      document.getElementById('top10Cumulative').style.background = mode === 'cumulative' ? 'var(--accent)' : 'transparent';
      document.getElementById('top10Cumulative').style.color = mode === 'cumulative' ? 'white' : 'var(--text)';
      
      // Top 10 ë‹¤ì‹œ ê³„ì‚°
      if(currentData) {
        updateQuickSelectTop10(currentData);
      }
    }
    
    function updateCountrySelect(data){
      if(!data || !data.Country) return;
      
      allCountriesList = data.Country.sort();
      
      // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (ìˆ¨ê¹€ ì²˜ë¦¬ë˜ì–´ ìˆì§€ë§Œ í˜¸í™˜ì„± ìœ ì§€)
      const select = document.getElementById('countrySelect');
      select.innerHTML = '<option value="">êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';
      allCountriesList.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        select.appendChild(option);
      });
      
      // íŠ¸ë˜í”½ ìˆœìœ„ ê³„ì‚° (ë¹ ë¥¸ ì„ íƒìš©)
      const stats = calculateStats(data);
      countryTrafficMap = {};
      for(let i = 0; i < stats.topCountries.length; i++){
        countryTrafficMap[stats.topCountries[i]] = {
          traffic: stats.topRevenue[i],
          change: stats.topChange[i],
          rank: i + 1
        };
      }
      
      // ë¹ ë¥¸ ì„ íƒ Top 10 ì—…ë°ì´íŠ¸
      updateQuickSelectTop10(data);
      
      // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
      initCountrySearch(data);
    }
    
    // ë¹ ë¥¸ ì„ íƒ Top 10 ì—…ë°ì´íŠ¸
    function updateQuickSelectTop10(data){
      const quickSelect = document.getElementById('quickSelectTop10');
      const dateInfo = document.getElementById('top10DateInfo');
      if(!quickSelect) return;
      
      const stats = calculateStats(data);
      let trafficTop10 = [];
      let dateInfoText = '';
      
      if(top10Mode === 'lastDay') {
        // ë§ˆì§€ë§‰ ì¼ ê¸°ì¤€ (ê¸°ì¡´ ë¡œì§)
        trafficTop10 = stats.trafficTop10 || [];
        const lastDate = data.allDates[data.allDates.length - 1];
        if(lastDate) {
          const d = new Date(lastDate);
          if(!isNaN(d)) {
            dateInfoText = `ğŸ“… ${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ê¸°ì¤€`;
          }
        }
      } else {
        // ê¸°ê°„ ëˆ„ì  ê¸°ì¤€ - ì „ì²´ ê¸°ê°„ íŠ¸ë˜í”½ í•©ê³„
        const countryTotals = {};
        const allCountries = data.Country;
        
        // ê° êµ­ê°€ë³„ ì „ì²´ ê¸°ê°„ íŠ¸ë˜í”½ í•©ê³„ ê³„ì‚°
        if(data.countryDataMap) {
          allCountries.forEach((country, idx) => {
            if(data.countryDataMap[country]) {
              let total = 0;
              Object.values(data.countryDataMap[country]).forEach(val => {
                total += Number(val) || 0;
              });
              if(total > 0) {
                countryTotals[country] = {
                  traffic: total,
                  change: stats.topChange[idx] || 0
                };
              }
            }
          });
        }
        
        // í•©ê³„ ê¸°ì¤€ Top 10
        trafficTop10 = Object.entries(countryTotals)
          .sort((a, b) => b[1].traffic - a[1].traffic)
          .slice(0, 10)
          .map(([country, d]) => ({
            country: country,
            traffic: d.traffic,
            change: d.change
          }));
        
        // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
        const firstDate = data.allDates[0];
        const lastDate = data.allDates[data.allDates.length - 1];
        if(firstDate && lastDate) {
          const d1 = new Date(firstDate);
          const d2 = new Date(lastDate);
          if(!isNaN(d1) && !isNaN(d2)) {
            dateInfoText = `ğŸ“… ${d1.getFullYear()}.${String(d1.getMonth()+1).padStart(2,'0')}.${String(d1.getDate()).padStart(2,'0')} ~ ${d2.getFullYear()}.${String(d2.getMonth()+1).padStart(2,'0')}.${String(d2.getDate()).padStart(2,'0')} ëˆ„ì `;
          }
        }
      }
      
      // ë‚ ì§œ ì •ë³´ ì—…ë°ì´íŠ¸
      if(dateInfo) {
        dateInfo.textContent = dateInfoText;
      }
      
      quickSelect.innerHTML = trafficTop10.map((item, idx) => {
        const country = item.country;
        const traffic = item.traffic;
        const change = item.change;
        const changeColor = change >= 0 ? '#00ff00' : '#ff4d4d';
        const changeSign = change >= 0 ? '+' : '';
        
        // íŠ¸ë˜í”½ í¬ë§·íŒ… (ë§ˆì§€ë§‰ ì¼ vs ëˆ„ì ì— ë”°ë¼ ë‹¤ë¥´ê²Œ)
        const trafficText = top10Mode === 'lastDay' 
          ? `${(traffic/1e6).toFixed(2)}M`
          : `${(traffic/1e9).toFixed(2)}B`;
        
        return `
          <button class="quick-select-btn" data-country="${country}" title="${country}: ${trafficText} (${changeSign}${change.toFixed(2)}%)">
            <div style="font-weight:600;margin-bottom:4px">${country}</div>
            <div style="font-size:11px;color:var(--muted)">#${idx + 1}</div>
            <div style="font-size:11px;color:${changeColor};margin-top:2px">${changeSign}${change.toFixed(1)}%</div>
          </button>
        `;
      }).join('');
      
      // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
      quickSelect.querySelectorAll('.quick-select-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const country = btn.getAttribute('data-country');
          // Country Detail íƒ­ìœ¼ë¡œ ì´ë™
          document.querySelector('[data-tab="country-detail"]').click();
          setTimeout(() => {
            showCountryDetail(data, country);
            // ê²€ìƒ‰ ì…ë ¥ì°½ì—ë„ í‘œì‹œ
            document.getElementById('countrySearch').value = country;
          }, 100);
        });
      });
    }
    
    // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
    function initCountrySearch(data){
      const searchInput = document.getElementById('countrySearch');
      const autocomplete = document.getElementById('countryAutocomplete');
      
      if(!searchInput || !autocomplete) return;
      
      let searchTimeout = null;
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        
        clearTimeout(searchTimeout);
        
        if(query.length === 0){
          autocomplete.style.display = 'none';
          return;
        }
        
        searchTimeout = setTimeout(() => {
          // êµ­ê°€ ê²€ìƒ‰
          const matches = allCountriesList.filter(country => 
            country.toLowerCase().includes(query)
          ).slice(0, 10); // ìµœëŒ€ 10ê°œ
          
          if(matches.length > 0){
            autocomplete.innerHTML = matches.map(country => {
              const highlight = country.replace(
                new RegExp(`(${query})`, 'gi'),
                '<strong style="color:#238636">$1</strong>'
              );
              return `
                <div class="country-autocomplete-item" data-country="${country}">
                  ${highlight}
                </div>
              `;
            }).join('');
            
            autocomplete.style.display = 'block';
            
            // í´ë¦­ ì´ë²¤íŠ¸
            autocomplete.querySelectorAll('.country-autocomplete-item').forEach(item => {
              item.addEventListener('click', () => {
                const country = item.getAttribute('data-country');
                searchInput.value = country;
                autocomplete.style.display = 'none';
                showCountryDetail(data, country);
              });
              
              item.addEventListener('mouseenter', () => {
                autocomplete.querySelectorAll('.country-autocomplete-item').forEach(i => i.classList.remove('highlight'));
                item.classList.add('highlight');
              });
            });
          } else {
            autocomplete.innerHTML = '<div style="padding:12px;color:var(--muted);text-align:center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            autocomplete.style.display = 'block';
          }
        }, 200);
      });
      
      // Enter í‚¤ë¡œ ì²« ë²ˆì§¸ ê²°ê³¼ ì„ íƒ
      searchInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          const firstItem = autocomplete.querySelector('.country-autocomplete-item');
          if(firstItem){
            firstItem.click();
          }
        } else if(e.key === 'Escape'){
          autocomplete.style.display = 'none';
        }
      });
      
      // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ë‹«ê¸°
      document.addEventListener('click', (e) => {
        if(!searchInput.contains(e.target) && !autocomplete.contains(e.target)){
          autocomplete.style.display = 'none';
        }
      });
    }
    
    // ì™¸ë¶€ì—ì„œ êµ­ê°€ ì„ íƒ í•¨ìˆ˜ (Treemap, Risers/Fallersì—ì„œ í˜¸ì¶œ)
    function selectCountryFromExternal(country){
      if(!country || !currentData) return;
      
      // Country Detail íƒ­ìœ¼ë¡œ ì´ë™
      const tabButton = document.querySelector('[data-tab="country-detail"]');
      if(tabButton){
        tabButton.click();
        setTimeout(() => {
          showCountryDetail(currentData, country);
          document.getElementById('countrySearch').value = country;
        }, 100);
      }
    }

    function showCountryDetail(data, country){
      // countryDataMap ì‚¬ìš© (ì¸ë±ìŠ¤ ë¶ˆì¼ì¹˜ ë°©ì§€)
      const countryData = data.countryDataMap ? data.countryDataMap[country] : null;
      
      if(!countryData) return;
      
      const comparisonType = document.getElementById('comparisonType').value || 'DoD';
      const lastDateIndex = data.allDates.length - 1;
      const lastDateKey = data.allDates[lastDateIndex];
      const lastTraffic = countryData[lastDateKey] || 0;
      let lastTrafficForCalc = lastTraffic; // WoW/MoM/QoQì—ì„œ ê¸°ê°„ í•©ê³„ë¡œ ë³€ê²½ë¨
      
      // Calculate change
      let compareValue = null;
      const lastDateObj = new Date(lastDateKey);
      
      if(!isNaN(lastDateObj)){
        const compareDateObj = new Date(lastDateObj);
        
        switch(comparisonType){
          case 'DoD':
            // ì „ì¼ ëŒ€ë¹„ (ë§ˆì§€ë§‰ ë‚  vs ì „ë‚ )
            if(data.allDates.length > 1){
              const prevDayDate = data.allDates[data.allDates.length - 2];
              if(countryData[prevDayDate] !== undefined){
                compareValue = countryData[prevDayDate];
              }
            }
            break;
          case 'Period':
            // ê¸°ê°„ ì „ì²´ (ë§ˆì§€ë§‰ ë‚  vs ì²«ë‚ )
            if(data.allDates.length > 0 && countryData[data.allDates[0]] !== undefined){
              compareValue = countryData[data.allDates[0]];
            }
            break;
          case 'WoW':
            // Week over Week: ìµœê·¼ 7ì¼ í•©ê³„ vs ì´ì „ 7ì¼ í•©ê³„
            {
              const periodDays = 7;
              let currentSum = 0, prevSum = 0;
              const lastIdx = data.allDates.length - 1;
              
              for(let d = 0; d < periodDays && (lastIdx - d) >= 0; d++){
                const dateKey = data.allDates[lastIdx - d];
                if(countryData[dateKey] !== undefined){
                  currentSum += countryData[dateKey];
                }
              }
              for(let d = periodDays; d < periodDays * 2 && (lastIdx - d) >= 0; d++){
                const dateKey = data.allDates[lastIdx - d];
                if(countryData[dateKey] !== undefined){
                  prevSum += countryData[dateKey];
                }
              }
              
              if(prevSum > 0) compareValue = prevSum;
              if(currentSum > 0) lastTrafficForCalc = currentSum;
            }
            break;
          case 'MoM':
            // Month over Month: ìµœê·¼ 30ì¼ í•©ê³„ vs ì´ì „ 30ì¼ í•©ê³„
            {
              const periodDays = 30;
              let currentSum = 0, prevSum = 0;
              const lastIdx = data.allDates.length - 1;
              
              for(let d = 0; d < periodDays && (lastIdx - d) >= 0; d++){
                const dateKey = data.allDates[lastIdx - d];
                if(countryData[dateKey] !== undefined){
                  currentSum += countryData[dateKey];
                }
              }
              for(let d = periodDays; d < periodDays * 2 && (lastIdx - d) >= 0; d++){
                const dateKey = data.allDates[lastIdx - d];
                if(countryData[dateKey] !== undefined){
                  prevSum += countryData[dateKey];
                }
              }
              
              if(prevSum > 0) compareValue = prevSum;
              if(currentSum > 0) lastTrafficForCalc = currentSum;
            }
            break;
          case 'QoQ':
            // Quarter over Quarter: ìµœê·¼ 90ì¼ í•©ê³„ vs ì´ì „ 90ì¼ í•©ê³„
            {
              const periodDays = 90;
              let currentSum = 0, prevSum = 0;
              const lastIdx = data.allDates.length - 1;
              
              for(let d = 0; d < periodDays && (lastIdx - d) >= 0; d++){
                const dateKey = data.allDates[lastIdx - d];
                if(countryData[dateKey] !== undefined){
                  currentSum += countryData[dateKey];
                }
              }
              for(let d = periodDays; d < periodDays * 2 && (lastIdx - d) >= 0; d++){
                const dateKey = data.allDates[lastIdx - d];
                if(countryData[dateKey] !== undefined){
                  prevSum += countryData[dateKey];
                }
              }
              
              if(prevSum > 0) compareValue = prevSum;
              if(currentSum > 0) lastTrafficForCalc = currentSum;
            }
            break;
          case 'YoY':
            compareDateObj.setFullYear(compareDateObj.getFullYear() - 1);
            const yoyDates = data.allDates.filter(d => {
              const dObj = new Date(d);
              const diff = Math.abs((dObj - compareDateObj) / (1000 * 60 * 60 * 24));
              return diff <= 7;
            });
            if(yoyDates.length > 0){
              const closestDate = yoyDates.sort((a,b) => {
                const aDiff = Math.abs((new Date(a) - compareDateObj) / (1000 * 60 * 60 * 24));
                const bDiff = Math.abs((new Date(b) - compareDateObj) / (1000 * 60 * 60 * 24));
                return aDiff - bDiff;
              })[0];
              if(countryData[closestDate] !== undefined){
                compareValue = countryData[closestDate];
              }
            }
            break;
        }
      }
      
      const change = (compareValue !== null && compareValue > 0 && lastTrafficForCalc > 0) 
        ? ((lastTrafficForCalc - compareValue) / compareValue) * 100 
        : 0;
      const continent = getContinent(country);
      
      // Get traffic history (countryDataMap ì‚¬ìš©)
      const trafficHistory = [];
      data.allDates.forEach((date) => {
        if(countryData[date] !== undefined){
          trafficHistory.push({
            date: date,
            traffic: countryData[date]
          });
        }
      });
      
      // Update stats
      // ë™ì  ë‹¨ìœ„ í¬ë§· í•¨ìˆ˜
      function formatTraffic(value) {
        if(value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
        if(value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
        if(value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
        return value.toFixed(0);
      }
      
      // ê¸°ê°„ í•©ê³„ ì—¬ë¶€ì— ë”°ë¥¸ ë¼ë²¨/ê°’ ê²°ì •
      const isPeriodSum = ['WoW', 'MoM', 'QoQ'].includes(comparisonType);
      const displayValue = isPeriodSum ? lastTrafficForCalc : lastTraffic;
      const trafficLabel = isPeriodSum 
        ? `Traffic (${comparisonType === 'WoW' ? '7ì¼' : comparisonType === 'MoM' ? '30ì¼' : '90ì¼'} í•©ê³„)`
        : 'Current Traffic';
      
      const statsHTML = `
        <div class="detail-stat-item">
          <div class="detail-stat-label">${trafficLabel}</div>
          <div class="detail-stat-value">${formatTraffic(displayValue)}</div>
        </div>
        <div class="detail-stat-item">
          <div class="detail-stat-label">Change (${comparisonType})</div>
          <div class="detail-stat-value" style="color:${change >= 0 ? '#00ff00' : '#ff4d4d'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
        </div>
        <div class="detail-stat-item">
          <div class="detail-stat-label">Sector</div>
          <div class="detail-stat-value" style="font-size:18px">${continent}</div>
        </div>
        <div class="detail-stat-item">
          <div class="detail-stat-label">Data Points</div>
          <div class="detail-stat-value" style="font-size:18px">${trafficHistory.length}</div>
        </div>
      `;
      
      document.getElementById('countryDetailStats').innerHTML = statsHTML;
      
      // Update chart
      if(trafficHistory.length > 0){
        const trace = {
          x: trafficHistory.map(d => d.date),
          y: trafficHistory.map(d => d.traffic),
          type: 'scatter',
          mode: 'lines+markers',
          name: country,
          line: {color: change >= 0 ? '#00ff00' : '#ff4d4d', width: 2},
          marker: {size: 6, color: change >= 0 ? '#00ff00' : '#ff4d4d'}
        };
        
        const layout = {
          paper_bgcolor: '#262931',
          plot_bgcolor: '#262931',
          font: {color: '#fff', family: 'Arial, Helvetica, sans-serif'},
          xaxis: {gridcolor: '#30363d', title: 'Date'},
          yaxis: {gridcolor: '#30363d', title: 'Traffic'},
          margin: {l: 60, r: 20, t: 20, b: 50},
          hovermode: 'closest'
        };
        
        Plotly.newPlot('countryTrafficChart', [trace], layout, {responsive: true});
      }
      
      document.getElementById('countryDetailContent').style.display = 'block';
      document.getElementById('countryDetailEmpty').style.display = 'none';
    }

    // ---------- News & Headlines Tab ----------
    let allNewsData = []; // ì „ì²´ ë‰´ìŠ¤ ë°ì´í„° ì €ì¥
    let currentCategoryFilter = 'all'; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬
    let currentNewsTypeFilter = 'all'; // í˜„ì¬ ì„ íƒëœ ë‰´ìŠ¤ íƒ€ì… (all, traffic_impact, gaming)
    
    // ê·¸ë£¹ë³„ ìƒ‰ìƒ ì •ì˜
    const groupColors = {
      'outage_block': '#ff4757',
      'social_crisis': '#ffa502',
      'seasonal_calendar': '#2ed573',
      'gaming_competitor': '#5352ed',
      'other': '#95a5a6'
    };
    
    // ë‰´ìŠ¤ íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì •ì˜
    const newsTypeStyles = {
      'traffic_impact': { icon: 'âš¡', label: 'íŠ¸ë˜í”½ ì˜í–¥', color: '#ff6b6b', bgColor: 'rgba(255,107,107,0.15)' },
      'gaming': { icon: 'ğŸ®', label: 'ê²Œì„ ë‰´ìŠ¤', color: '#5352ed', bgColor: 'rgba(83,82,237,0.15)' }
    };
    
    // category_group ë§¤í•‘ í•¨ìˆ˜ (í•œ ë²ˆë§Œ ì •ì˜, ì¬ì‚¬ìš©)
    const mapToGroupCategory = (detailCategory) => {
      const outageBlock = ['internet_shutdown', 'tech_outage', 'power_outage', 'censorship', 'cyber_attack', 'infrastructure_damage'];
      const socialCrisis = ['war_conflict', 'terrorism_explosion', 'natural_disaster', 'protest_strike', 'curfew', 'pandemic', 'economic'];
      const seasonalCalendar = ['holiday', 'school_calendar', 'election'];
      const gamingCompetitor = ['gaming', 'competitor_game', 'social_trend', 'sports_event', 'major_event'];
      
      if (outageBlock.includes(detailCategory)) return 'outage_block';
      if (socialCrisis.includes(detailCategory)) return 'social_crisis';
      if (seasonalCalendar.includes(detailCategory)) return 'seasonal_calendar';
      if (gamingCompetitor.includes(detailCategory)) return 'gaming_competitor';
      return 'other';
    };
    
    // ë‰´ìŠ¤ íƒ€ì… ì¶”ë¡  í•¨ìˆ˜
    const inferNewsType = (news) => {
      // CSVì— news_typeì´ ìˆìœ¼ë©´ ì‚¬ìš©
      if (news.news_type) return news.news_type;
      
      // category_groupìœ¼ë¡œ ì¶”ë¡ 
      const group = news.category_group || mapToGroupCategory(news.category || 'other');
      
      // íŠ¸ë˜í”½ ì˜í–¥ ê´€ë ¨ ê·¸ë£¹
      if (['outage_block', 'social_crisis', 'seasonal_calendar'].includes(group)) {
        return 'traffic_impact';
      }
      
      // ê²Œì„ ê´€ë ¨
      return 'gaming';
    };
    
    // CSVì—ì„œ ë‰´ìŠ¤ ë¡œë“œ
    async function loadNewsFromCSV(){
      const newsList = document.getElementById('newsList');
      
      // ë¡œë”© í‘œì‹œ
      newsList.innerHTML = `
        <div class="empty-state">
          <div class="loading-spinner" style="margin:0 auto"></div>
          <div style="margin-top:12px">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      `;
      
      try {
        const fetchStartTime = performance.now();
        const response = await fetch('data/news.csv');
        if(!response.ok){
          throw new Error('ë‰´ìŠ¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const csvText = await response.text();
        const fetchTime = performance.now() - fetchStartTime;
        console.log(`CSV íŒŒì¼ fetch ì‹œê°„: ${fetchTime.toFixed(2)}ms`);
        
        // CSV íŒŒì‹± ì‹œì‘ ì‹œê°„ ì¸¡ì •
        const parseStartTime = performance.now();
        
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          worker: false, // ì›Œì»¤ ìŠ¤ë ˆë“œ ì‚¬ìš© ì•ˆ í•¨ (ì‘ì€ íŒŒì¼)
          complete: (results) => {
            const parseTime = performance.now() - parseStartTime;
            console.log(`CSV íŒŒì‹± ì‹œê°„: ${parseTime.toFixed(2)}ms`);
            
            // category_group ë§¤í•‘ì€ ì „ì—­ í•¨ìˆ˜ ì‚¬ìš© (ì¤‘ë³µ ì œê±°)
            
            const mapStartTime = performance.now();
            // HTML íƒœê·¸ ì œê±°ë¥¼ ìœ„í•œ ì •ê·œì‹ (í•œ ë²ˆë§Œ ì»´íŒŒì¼)
            const htmlTagRegex = /<[^>]*>/g;
            
            allNewsData = results.data.map(row => {
              // HTML íƒœê·¸ ì œê±° (summaryì—ì„œ) - ì •ê·œì‹ ì¬ì‚¬ìš©
              const cleanSummary = (row.summary || '').replace(htmlTagRegex, '').trim();
              const cleanTitle = (row.title || '').replace(htmlTagRegex, '').trim();
              
              const category = row.category || 'other';
              // category_groupì´ CSVì— ì—†ìœ¼ë©´ ìë™ ë§¤í•‘ (ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©)
              const categoryGroup = row.category_group || mapToGroupCategory(category);
              
              const newsItem = {
                date: row.date || '',
                country: row.country || '',
                continent: row.continent || '',
                title: cleanTitle,
                summary: cleanSummary,
                url: row.url || '#',
                source: row.source || 'Unknown',
                category: category,
                category_group: categoryGroup,
                news_type: row.news_type || '', // CSVì—ì„œ news_type ë¡œë“œ
                traffic_impact: row.traffic_impact || '',
                priority: row.priority || 'medium'
              };
              
              // news_typeì´ ì—†ìœ¼ë©´ ì¶”ë¡ 
              if (!newsItem.news_type) {
                newsItem.news_type = inferNewsType(newsItem);
              }
              
              return newsItem;
            });
            const mapTime = performance.now() - mapStartTime;
            console.log(`ë°ì´í„° ë§¤í•‘ ì‹œê°„: ${mapTime.toFixed(2)}ms`);
            
            // í†µê³„ ê³„ì‚°
            const groupStats = {};
            let trafficCount = 0;
            let gamingCount = 0;
            
            allNewsData.forEach(news => {
              const group = news.category_group || 'other';
              groupStats[group] = (groupStats[group] || 0) + 1;
              
              if (news.news_type === 'traffic_impact') trafficCount++;
              else gamingCount++;
            });
            
            console.log('ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ë³„ ë‰´ìŠ¤ ìˆ˜:', groupStats);
            console.log(`ë‰´ìŠ¤ íƒ€ì…: íŠ¸ë˜í”½ ì˜í–¥ ${trafficCount}ê°œ, ê²Œì„ ${gamingCount}ê°œ`);
            
            // í†µê³„ UI ì—…ë°ì´íŠ¸
            document.getElementById('totalNewsCount').textContent = allNewsData.length;
            document.getElementById('trafficNewsCount').textContent = trafficCount;
            document.getElementById('gamingNewsCount').textContent = gamingCount;
            
            applyNewsFilters();
            
            // íŠ¸ë˜í”½ ì˜í–¥ ìš”ì•½ ìƒì„±
            generateTrafficSummary(allNewsData);
          },
          error: (error) => {
            console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
            newsList.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">âš ï¸</div>
                <div>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                <div style="margin-top:12px;font-size:12px;color:var(--muted)">${error.message}</div>
              </div>
            `;
          }
        });
      } catch(error){
        console.error('ë‰´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
        newsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            <div style="margin-top:12px;font-size:12px;color:var(--muted)">${error.message}</div>
          </div>
        `;
      }
    }
    
    // í†µí•© í•„í„° ì ìš© í•¨ìˆ˜
    function applyNewsFilters(){
      const filterStartTime = performance.now();
      
      let filteredNews = allNewsData;
      
      // 1. ë‰´ìŠ¤ íƒ€ì… í•„í„°ë§
      if(currentNewsTypeFilter !== 'all'){
        filteredNews = filteredNews.filter(news => news.news_type === currentNewsTypeFilter);
      }
      
      // 2. ì¹´í…Œê³ ë¦¬ í•„í„°ë§
      if(currentCategoryFilter !== 'all'){
        filteredNews = filteredNews.filter(news => {
          if (!news.category_group) {
            news.category_group = mapToGroupCategory(news.category || 'other');
          }
          return news.category_group === currentCategoryFilter;
        });
      }
      
      // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
      filteredNews.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return isNaN(dateB) ? -1 : (isNaN(dateA) ? 1 : dateB - dateA);
      });
      
      const filterTime = performance.now() - filterStartTime;
      console.log(`í•„í„°ë§ ì‹œê°„: ${filterTime.toFixed(2)}ms, ê²°ê³¼: ${filteredNews.length}ê°œ`);
      
      renderNews(filteredNews);
    }
    
    // ë‰´ìŠ¤ íƒ€ì… í•„í„°ë§ (ìƒˆ ì¹´ë“œ UI)
    function filterNewsByType(type){
      currentNewsTypeFilter = type;
      
      // ë‰´ìŠ¤ íƒ€ì… ì¹´ë“œ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.news-type-filter').forEach(btn => {
        const btnType = btn.dataset.type;
        if(btnType === type){
          btn.classList.add('active');
          if(btnType === 'all'){
            btn.style.background = 'linear-gradient(135deg,#238636,#2ea043)';
            btn.style.color = '#fff';
            btn.style.border = 'none';
          } else if(btnType === 'traffic_impact'){
            btn.style.background = 'linear-gradient(135deg,#ff6b6b,#ee5a24)';
            btn.style.color = '#fff';
            btn.style.border = '2px solid #ff6b6b';
          } else if(btnType === 'gaming'){
            btn.style.background = 'linear-gradient(135deg,#5352ed,#3742fa)';
            btn.style.color = '#fff';
            btn.style.border = '2px solid #5352ed';
          }
        } else {
          btn.classList.remove('active');
          btn.style.background = 'var(--panel)';
          if(btnType === 'all'){
            btn.style.color = 'var(--muted)';
            btn.style.border = '1px solid var(--border)';
          } else if(btnType === 'traffic_impact'){
            btn.style.color = '#ff6b6b';
            btn.style.border = '2px solid #ff6b6b';
          } else if(btnType === 'gaming'){
            btn.style.color = '#5352ed';
            btn.style.border = '2px solid #5352ed';
          }
        }
      });
      
      applyNewsFilters();
    }
    
    // ì¹´í…Œê³ ë¦¬ í•„í„° í† ê¸€
    document.getElementById('toggleCategoryFilter')?.addEventListener('click', function(){
      const section = document.getElementById('categoryFilterSection');
      const icon = document.getElementById('categoryToggleIcon');
      if(section.style.display === 'none'){
        section.style.display = 'block';
        icon.textContent = 'â–²';
      } else {
        section.style.display = 'none';
        icon.textContent = 'â–¼';
      }
    });
    
    // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function markdownToHtml(text) {
      if (!text) return '';
      return text
        // ë³¼ë“œì²´ **text** -> <strong>text</strong>
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // ì´íƒ¤ë¦­ *text* -> <em>text</em>
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // ë¦¬ìŠ¤íŠ¸ * item -> â€¢ item
        .replace(/^\* /gm, 'â€¢ ')
        // ì¤„ë°”ê¿ˆ ìœ ì§€
        .replace(/\n/g, '<br>');
    }
    
    // íŠ¸ë˜í”½ ì˜í–¥ ìš”ì•½ ìƒì„± (summary.json ë¡œë“œ)
    async function generateTrafficSummary(newsData){
      const summaryContent = document.getElementById('trafficSummaryContent');
      const summaryMeta = document.getElementById('trafficSummaryMeta');
      
      // ë¡œë”© í‘œì‹œ
      summaryContent.innerHTML = `<div style="color:var(--muted)">ğŸ”„ AI ìš”ì•½ ë¡œë”© ì¤‘...</div>`;
      
      try {
        // summary.json ë¡œë“œ ì‹œë„
        const response = await fetch('data/summary.json');
        
        if(response.ok){
          const summaryData = await response.json();
          
          if(!summaryData.has_issues){
            // íŠ¹ì´ì‚¬í•­ ì—†ìŒ
            summaryContent.innerHTML = `
              <div style="color:#2ed573;font-size:18px;margin-bottom:12px">âœ… <strong>íŠ¹ì´ì‚¬í•­ ì—†ìŒ</strong></div>
              <div style="color:var(--text);font-size:14px;line-height:1.6">${summaryData.summary || 'ìµœê·¼ 24ì‹œê°„ ë™ì•ˆ ëª¨ë°”ì¼ ê²Œì„ íŠ¸ë˜í”½ì— ì˜í–¥ì„ ì¤„ ë§Œí•œ ì£¼ìš” ì´ìŠˆê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</div>
            `;
            summaryMeta.style.display = 'none';
          } else {
            // AI ìš”ì•½ í‘œì‹œ
            let html = '';
            
            // ì „ë¬¸ê°€ ë¶„ì„ ì„¹ì…˜
            html += `<div style="margin-bottom:20px">`;
            html += `<div style="font-weight:700;color:#5352ed;margin-bottom:12px;font-size:15px">ğŸ¥½ GPT + CLAUDE ë¶„ì„ ì˜ê²¬</div>`;
            html += `<div style="padding:16px;background:linear-gradient(135deg,rgba(83,82,237,0.1),rgba(46,213,115,0.05));border-radius:12px;border-left:4px solid #5352ed;font-size:14px;line-height:1.8">`;
            html += markdownToHtml(summaryData.summary) || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ';
            html += `</div></div>`;
            
            // ì˜í–¥ êµ­ê°€
            if(summaryData.affected_countries && summaryData.affected_countries.length > 0){
              const validCountries = summaryData.affected_countries.filter(c => c && c !== 'Unknown' && c !== 'nan');
              if(validCountries.length > 0){
                html += `<div style="margin-bottom:16px">`;
                html += `<div style="font-weight:700;color:#ffa502;margin-bottom:8px">ğŸŒ ì£¼ìš” ì˜í–¥ êµ­ê°€</div>`;
                html += `<div style="display:flex;flex-wrap:wrap;gap:8px">`;
                validCountries.forEach(country => {
                  html += `<span style="padding:6px 12px;background:rgba(255,165,2,0.15);border-radius:20px;font-size:13px;color:#ffa502">${country}</span>`;
                });
                html += `</div></div>`;
              }
            }
            
            // ì£¼ìš” ì´ìŠˆ ëª©ë¡
            if(summaryData.key_issues && summaryData.key_issues.length > 0){
              html += `<div>`;
              html += `<div style="font-weight:700;color:#ff6b6b;margin-bottom:8px">ğŸ“Œ ì£¼ìš” ì´ìŠˆ</div>`;
              summaryData.key_issues.forEach(issue => {
                const title = typeof issue === 'string' ? issue : issue.title;
                const country = typeof issue === 'object' ? issue.country : '';
                html += `<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px">`;
                if(country && country !== 'Unknown'){
                  html += `<span style="background:rgba(255,107,107,0.2);color:#ff6b6b;padding:2px 8px;border-radius:4px;margin-right:8px;font-size:11px">${country}</span>`;
                }
                html += `<span>${title}</span>`;
                html += `</div>`;
              });
              html += `</div>`;
            }
            
            summaryContent.innerHTML = html;
            summaryMeta.style.display = 'block';
            
            // ë©”íƒ€ ì •ë³´ ì—…ë°ì´íŠ¸
            const generatedAt = summaryData.generated_at ? new Date(summaryData.generated_at).toLocaleString('ko-KR') : new Date().toLocaleString('ko-KR');
            document.getElementById('summaryTime').textContent = generatedAt;
            document.getElementById('summaryNewsCount').textContent = summaryData.news_count || 0;
          }
        } else {
          throw new Error('summary.json not found');
        }
      } catch(error){
        console.log('summary.json ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ë¶„ì„ ìˆ˜í–‰:', error);
        
        // Fallback: í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê¸°ë³¸ ë¶„ì„
        generateTrafficSummaryFallback(newsData);
      }
    }
    
    // Fallback: í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê¸°ë³¸ ë¶„ì„ (summary.json ì—†ì„ ë•Œ)
    function generateTrafficSummaryFallback(newsData){
      const excludeKeywords = [
        'mama', 'awards', 'ì‹œìƒì‹', 'concert', 'ì½˜ì„œíŠ¸', 'idol', 'ì•„ì´ëŒ',
        'ê´‘ê³ ', 'ìº í˜ì¸', 'í”„ë¡œëª¨ì…˜', 'ì¦ì‹œ', 'ì½”ìŠ¤í”¼', 'ì±„ìš©', 'ë¶„ì–‘',
        'immigration protest', 'hindu protest', 'farmer protest',
        'kt ìœ„ì¦ˆ', 'í”„ë¡œì•¼êµ¬', 'í”„ë¡œì¶•êµ¬', 'nba', 'mlb',
        // ë°°êµ¬
        'spike war', 'ìŠ¤íŒŒì´í¬ ì›Œ', 'ë°°êµ¬', 'volleyball', 'vë¦¬ê·¸',
        "kim yo-han's serve", 'ì„œë¸Œ ë¦¬ì‹œë¸Œ',
        // â€» ë¶í•œ ì‚¬ì´ë²„ ê³µê²©ì€ ê²Œì„ ì„œë²„ ì˜í–¥ ê°€ëŠ¥ì„± ìˆì–´ ì‚´ë¦¼!
        // ì •ì¹˜/ë²•ì›
        'ppp', 'êµ­ë¯¼ì˜í˜', 'ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹', 'ë¯¼ì£¼ë‹¹', 'êµ­íšŒ',
        'court hearing', 'ë²•ì›', 'ì¬íŒ', 'íƒ„í•µ', 'choo kyung-ho',
        'ì¶”ê²½í˜¸', 'ì´ì¬ëª…', 'ìœ¤ì„ì—´', 'í•œë™í›ˆ', 'impeachment',
        // í•œêµ­ ê´€ë ¨ (ê¸€ë¡œë²Œ ê´€ì ì—ì„œ ì œì™¸)
        'í•œêµ­', 'south korea', 'korea', 'ë¶í•œ', 'north korea',
        'ì„œìš¸', 'seoul', 'ë„¤ì´íŠ¸', 'nate.com',
        // eìŠ¤í¬ì¸ 
        'esports', 'e-sports', 'eìŠ¤í¬ì¸ ', 'ì´ìŠ¤í¬ì¸ ',
        'pmgc', 'pmpl', 'tournament', 'í† ë„ˆë¨¼íŠ¸', 'ëŒ€íšŒ',
        'championship', 'league', 'ë¦¬ê·¸', 'í”„ë¡œì„ ìˆ˜', 'í”„ë¡œíŒ€'
      ];
      
      const seenTitles = new Set();
      const trafficNews = newsData.filter(n => {
        if(n.news_type !== 'traffic_impact') return false;
        const title = (n.title || '').toLowerCase();
        const titleKey = title.substring(0, 30);
        if(seenTitles.has(titleKey)) return false;
        seenTitles.add(titleKey);
        if(excludeKeywords.some(kw => title.includes(kw))) return false;
        return true;
      });
      
      const summaryContent = document.getElementById('trafficSummaryContent');
      const summaryMeta = document.getElementById('trafficSummaryMeta');
      
      if(trafficNews.length === 0){
        summaryContent.innerHTML = `
          <div style="color:#2ed573;font-size:18px;margin-bottom:12px">âœ… <strong>íŠ¹ì´ì‚¬í•­ ì—†ìŒ</strong></div>
          <div style="color:var(--text);font-size:14px">ìµœê·¼ 24ì‹œê°„ ë™ì•ˆ íŠ¸ë˜í”½ì— ì˜í–¥ì„ ì¤„ ë§Œí•œ ì£¼ìš” ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        `;
        summaryMeta.style.display = 'none';
        return;
      }
      
      // êµ­ê°€ë³„ ë¶„ë¥˜
      const countries = {};
      trafficNews.forEach(news => {
        const country = news.country || 'Unknown';
        if(country && country !== 'Unknown' && country !== 'nan'){
          if(!countries[country]) countries[country] = [];
          countries[country].push(news);
        }
      });
      
      const topCountries = Object.keys(countries).sort((a,b) => countries[b].length - countries[a].length).slice(0, 5);
      
      let html = `<div style="padding:12px;background:rgba(255,165,2,0.1);border-radius:8px;margin-bottom:16px">`;
      html += `<div style="color:#ffa502;font-weight:600;margin-bottom:8px">âš ï¸ AI ìš”ì•½ ë¯¸ìƒì„±</div>`;
      html += `<div style="font-size:13px;color:var(--text)">ë¡œì»¬ì—ì„œ ë‰´ìŠ¤ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ AI ìš”ì•½ì´ ìƒì„±ë©ë‹ˆë‹¤.</div>`;
      html += `</div>`;
      
      html += `<div style="margin-bottom:12px">`;
      html += `<strong>ğŸ“Š ê¸°ë³¸ ë¶„ì„:</strong> íŠ¸ë˜í”½ ì˜í–¥ ë‰´ìŠ¤ ${trafficNews.length}ê±´ ê°ì§€`;
      html += `</div>`;
      
      if(topCountries.length > 0){
        html += `<div><strong>ğŸŒ ì˜í–¥ êµ­ê°€:</strong> ${topCountries.join(', ')}</div>`;
      }
      
      summaryContent.innerHTML = html;
      summaryMeta.style.display = 'block';
      document.getElementById('summaryTime').textContent = new Date().toLocaleString('ko-KR');
      document.getElementById('summaryNewsCount').textContent = trafficNews.length;
    }
    
    // ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§ (ê·¸ë£¹ ì¹´í…Œê³ ë¦¬ ê¸°ì¤€)
    function filterNewsByCategory(category){
      currentCategoryFilter = category;
      
      // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.category-filter').forEach(btn => {
        if(btn.dataset.category === category){
          btn.classList.add('active');
          if(category === 'all'){
            btn.style.background = 'linear-gradient(135deg,#238636,#2ea043)';
            btn.style.color = '#fff';
            btn.style.border = 'none';
          } else {
            const groupColor = groupColors[category] || groupColors['other'];
            btn.style.background = groupColor;
            btn.style.color = '#fff';
            btn.style.border = `2px solid ${groupColor}`;
          }
        } else {
          btn.classList.remove('active');
          if(btn.dataset.category === 'all'){
            btn.style.background = 'linear-gradient(135deg,#238636,#2ea043)';
            btn.style.color = '#fff';
            btn.style.border = 'none';
          } else {
            const groupColor = groupColors[btn.dataset.category] || groupColors['other'];
            btn.style.background = 'var(--panel)';
            btn.style.color = groupColor;
            btn.style.border = `2px solid ${groupColor}`;
          }
        }
      });
      
      applyNewsFilters();
    }
    
    // ë‰´ìŠ¤ íƒ€ì… í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('.news-type-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        filterNewsByType(btn.dataset.type);
      });
    });
    
    // ì¹´í…Œê³ ë¦¬ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('.category-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        filterNewsByCategory(btn.dataset.category);
      });
    });
    
    async function loadNews(countries = null){
      // CSVì—ì„œ ë‰´ìŠ¤ ë¡œë“œ (ê¸°ì¡´ API ë°©ì‹ ëŒ€ì²´)
      try {
        await loadNewsFromCSV();
      } catch(error) {
        console.error('ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
        renderSampleNews(countries);
      }
    }

    // RSS í”¼ë“œì—ì„œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (API í‚¤ ë¶ˆí•„ìš”)
    async function fetchNewsFromRSS(countries = null){
      const news = [];
      
      try {
        // ê²€ìƒ‰ í‚¤ì›Œë“œ ìƒì„±
        let searchTerms = 'PUBG Mobile mobile game';
        if(countries && countries.length > 0){
          // ìƒìŠ¹ êµ­ê°€ì™€ í•˜ë½ êµ­ê°€ë¥¼ êµ¬ë¶„í•˜ì—¬ ê²€ìƒ‰
          const risers = countries.filter(c => c.type === 'riser').map(c => c.country);
          const fallers = countries.filter(c => c.type === 'faller').map(c => c.country);
          
          if(risers.length > 0){
            searchTerms += ` (${risers.slice(0, 3).join(' OR ')})`;
          }
        }
        
        // ì—¬ëŸ¬ RSS ì†ŒìŠ¤ ì‹œë„ (CORS í”„ë¡ì‹œ ì‚¬ìš©)
        const corsProxies = [
          'https://api.allorigins.win/get?url=',
          'https://corsproxy.io/?',
          'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        const rssUrls = [
          // Google News RSS - PUBG Mobile ê²€ìƒ‰
          `https://news.google.com/rss/search?q=${encodeURIComponent(searchTerms)}&hl=ko&gl=KR&ceid=KR:ko`,
          // Google News RSS - ëª¨ë°”ì¼ ê²Œì„ ì¼ë°˜
          `https://news.google.com/rss/search?q=${encodeURIComponent('mobile game traffic')}&hl=ko&gl=KR&ceid=KR:ko`,
        ];
        
        // ê° í”„ë¡ì‹œì™€ RSS ì†ŒìŠ¤ ì¡°í•© ì‹œë„
        for(const rssUrl of rssUrls){
          for(const proxy of corsProxies){
            try {
              const fullUrl = proxy + encodeURIComponent(rssUrl);
              const response = await fetch(fullUrl, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json'
                }
              });
              
              if(!response.ok) continue;
              
              const data = await response.json();
              const xmlContent = data.contents || data || '';
              
              // RSS íŒŒì‹±
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
              
              // íŒŒì‹± ì˜¤ë¥˜ í™•ì¸
              const parseError = xmlDoc.querySelector('parsererror');
              if(parseError) {
                console.warn('XML íŒŒì‹± ì˜¤ë¥˜:', parseError.textContent);
                continue;
              }
              
              const items = xmlDoc.querySelectorAll('item');
              
              if(items.length === 0) continue;
              
              items.forEach((item, index) => {
                if(index >= 15) return; // ìµœëŒ€ 15ê°œ
                
                const title = item.querySelector('title')?.textContent || '';
                const link = item.querySelector('link')?.textContent || 
                           item.querySelector('guid')?.textContent || '#';
                const pubDate = item.querySelector('pubDate')?.textContent || 
                              item.querySelector('pubdate')?.textContent || '';
                const description = item.querySelector('description')?.textContent || '';
                const source = item.querySelector('source')?.textContent || 
                             item.querySelector('dc\\:creator')?.textContent || 'Google News';
                
                // ì¤‘ë³µ ì œê±°
                if(news.some(n => n.title === title)) return;
                
                // ê´€ë ¨ êµ­ê°€ í™•ì¸
                let relatedCountry = null;
                let changeType = null;
                if(countries){
                  for(const country of countries){
                    const countryLower = country.country.toLowerCase();
                    const titleLower = title.toLowerCase();
                    const descLower = description.toLowerCase();
                    
                    if(titleLower.includes(countryLower) || descLower.includes(countryLower)){
                      relatedCountry = country.country;
                      changeType = country.type; // 'riser' or 'faller'
                      break;
                    }
                  }
                }
                
                // PUBG Mobile ê´€ë ¨ í‚¤ì›Œë“œ í™•ì¸
                const relevantKeywords = ['pubg', 'mobile game', 'mobile gaming', 'game traffic', 'dau', 'user'];
                const isRelevant = relevantKeywords.some(keyword => 
                  title.toLowerCase().includes(keyword) || description.toLowerCase().includes(keyword)
                );
                
                // ê´€ë ¨ì„±ì´ ìˆê±°ë‚˜ êµ­ê°€ íƒœê·¸ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                if(isRelevant || relatedCountry){
                  news.push({
                    title: title.replace(/<[^>]*>/g, '').trim(),
                    source: source.replace(/<[^>]*>/g, '').trim(),
                    date: formatDate(pubDate),
                    snippet: description.replace(/<[^>]*>/g, '').trim().substring(0, 200) + (description.length > 200 ? '...' : ''),
                    url: link,
                    relatedCountry: relatedCountry,
                    changeType: changeType
                  });
                }
              });
              
              if(news.length >= 10) break; // ì¶©ë¶„í•œ ë‰´ìŠ¤ê°€ ìˆìœ¼ë©´ ì¤‘ë‹¨
            } catch(err) {
              console.warn('RSS ì†ŒìŠ¤ ì‹¤íŒ¨:', err.message);
              continue;
            }
          }
          
          if(news.length >= 10) break; // ì¶©ë¶„í•œ ë‰´ìŠ¤ê°€ ìˆìœ¼ë©´ ì¤‘ë‹¨
        }
        
        // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
        news.sort((a, b) => new Date(b.date) - new Date(a.date));
        
      } catch(error) {
        console.error('RSS í”¼ë“œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
      }
      
      return news;
    }

    // Gemini APIë¡œ ë‰´ìŠ¤ ê²€ìƒ‰ ë° ì›ì¸ ë¶„ì„ (API í‚¤ í•„ìš”, ë¬´ë£Œ í‹°ì–´ ì‚¬ìš© ê°€ëŠ¥)
    async function fetchNewsFromGemini(countries = null){
      const apiKey = window.API_CONFIG?.GEMINI_API_KEY;
      if(!apiKey || apiKey === 'YOUR_GEMINI_API_KEY_HERE') return null;
      
      try {
        // ìƒìŠ¹/í•˜ë½ êµ­ê°€ êµ¬ë¶„
        const risers = countries ? countries.filter(c => c.type === 'riser') : [];
        const fallers = countries ? countries.filter(c => c.type === 'faller') : [];
        
        let prompt = `ë‹¤ìŒì€ PUBG Mobile ê²Œì„ì˜ êµ­ê°€ë³„ íŠ¸ë˜í”½ ë³€í™” ë°ì´í„°ì…ë‹ˆë‹¤:\n\n`;
        
        if(risers.length > 0){
          prompt += `ğŸ“ˆ íŠ¸ë˜í”½ì´ 5% ì´ìƒ ìƒìŠ¹í•œ êµ­ê°€:\n`;
          risers.forEach(c => {
            prompt += `- ${c.country}: ${c.change.toFixed(2)}% ìƒìŠ¹\n`;
          });
          prompt += `\nì´ êµ­ê°€ë“¤ì˜ íŠ¸ë˜í”½ ìƒìŠ¹ ì›ì¸ì„ ë¶„ì„í•˜ê³ , ê´€ë ¨ëœ ìµœì‹  ë‰´ìŠ¤ë‚˜ ì´ë²¤íŠ¸ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.\n\n`;
        }
        
        if(fallers.length > 0){
          prompt += `ğŸ“‰ íŠ¸ë˜í”½ì´ 5% ì´ìƒ í•˜ë½í•œ êµ­ê°€:\n`;
          fallers.forEach(c => {
            prompt += `- ${c.country}: ${c.change.toFixed(2)}% í•˜ë½\n`;
          });
          prompt += `\nì´ êµ­ê°€ë“¤ì˜ íŠ¸ë˜í”½ í•˜ë½ ì›ì¸ì„ ë¶„ì„í•˜ê³ , ê´€ë ¨ëœ ìµœì‹  ë‰´ìŠ¤ë‚˜ ì´ë²¤íŠ¸ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.\n\n`;
        }
        
        if(!risers.length && !fallers.length){
          prompt += `PUBG Mobileì˜ ê¸€ë¡œë²Œ íŠ¸ë˜í”½ê³¼ ê´€ë ¨ëœ ìµœì‹  ë‰´ìŠ¤ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.\n\n`;
        }
        
        prompt += `ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ JSON ë°°ì—´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ê° ë‰´ìŠ¤ë§ˆë‹¤):
[
  {
    "title": "ë‰´ìŠ¤ ì œëª©",
    "source": "ì¶œì²˜",
    "date": "ë‚ ì§œ",
    "snippet": "ìš”ì•½ (2-3ë¬¸ì¥)",
    "url": "ë§í¬ (ê°€ëŠ¥í•œ ê²½ìš°)",
    "relatedCountry": "ê´€ë ¨ êµ­ê°€ (ì—†ìœ¼ë©´ null)",
    "reason": "íŠ¸ë˜í”½ ë³€í™” ì›ì¸ ë¶„ì„ (ìƒìŠ¹/í•˜ë½ ì´ìœ )"
  }
]

ìµœê·¼ 24ì‹œê°„ ì´ë‚´ì˜ ë‰´ìŠ¤ë§Œ í¬í•¨í•˜ê³ , ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ë‰´ìŠ¤ë§Œ ì•Œë ¤ì£¼ì„¸ìš”. ìµœëŒ€ 10ê°œê¹Œì§€.`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }],
            generationConfig: {
              temperature: 0.7,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 2048,
            }
          })
        });
        
        if(!response.ok) {
          throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Gemini ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        
        if(!responseText) {
          console.warn('Gemini ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
          return null;
        }
        
        // JSON íŒŒì‹± ì‹œë„ (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°)
        let jsonText = responseText.trim();
        
        // ```json ë˜ëŠ” ```ë¡œ ê°ì‹¸ì§„ ê²½ìš° ì œê±°
        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        // JSON ë°°ì—´ ì¶”ì¶œ ì‹œë„
        const jsonMatch = jsonText.match(/\[[\s\S]*\]/);
        if(jsonMatch) {
          jsonText = jsonMatch[0];
        }
        
        try {
          const newsArray = JSON.parse(jsonText);
          
          // ë‰´ìŠ¤ í˜•ì‹ ë³€í™˜
          return newsArray.map(news => ({
            title: news.title || 'ì œëª© ì—†ìŒ',
            source: news.source || 'Gemini AI',
            date: news.date || new Date().toLocaleDateString('ko-KR'),
            snippet: news.snippet || '',
            url: news.url || '#',
            relatedCountry: news.relatedCountry || null,
            changeType: risers.some(c => c.country === news.relatedCountry) ? 'riser' : 
                       fallers.some(c => c.country === news.relatedCountry) ? 'faller' : null,
            reason: news.reason || null // íŠ¸ë˜í”½ ë³€í™” ì›ì¸
          }));
        } catch(parseError) {
          // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ì—ì„œ ë‰´ìŠ¤ ì •ë³´ ì¶”ì¶œ ì‹œë„
          console.warn('JSON íŒŒì‹± ì‹¤íŒ¨, í…ìŠ¤íŠ¸ íŒŒì‹± ì‹œë„:', parseError);
          
          // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ íŒŒì‹± (í´ë°±)
          const newsItems = [];
          const lines = responseText.split('\n').filter(l => l.trim());
          
          let currentNews = null;
          for(const line of lines) {
            if(line.includes('title') || line.includes('ì œëª©')) {
              currentNews = { title: line.replace(/.*title.*[:ï¼š]\s*/i, '').trim() };
            } else if(line.includes('source') || line.includes('ì¶œì²˜')) {
              if(currentNews) currentNews.source = line.replace(/.*source.*[:ï¼š]\s*/i, '').trim();
            } else if(line.includes('reason') || line.includes('ì›ì¸')) {
              if(currentNews) currentNews.reason = line.replace(/.*reason.*[:ï¼š]\s*/i, '').trim();
            }
          }
          
          if(newsItems.length > 0) return newsItems;
          
          // ìµœì¢… í´ë°±: Gemini ì‘ë‹µì„ ê·¸ëŒ€ë¡œ í‘œì‹œ
          return [{
            title: 'Gemini AI ë¶„ì„ ê²°ê³¼',
            source: 'Gemini AI',
            date: new Date().toLocaleDateString('ko-KR'),
            snippet: responseText.substring(0, 500) + '...',
            url: '#',
            relatedCountry: null,
            reason: null
          }];
        }
      } catch(error) {
        console.error('Gemini API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        return null;
      }
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString){
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch {
        return new Date().toLocaleDateString('ko-KR');
      }
    }

    // ë‰´ìŠ¤ ë Œë”ë§
    function renderNews(newsArray){
      const renderStartTime = performance.now();
      const newsList = document.getElementById('newsList');
      
      if(newsArray.length > 0){
        // ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜
        const categoryIcons = {
          'internet_shutdown': 'ğŸ“¡', 'tech_outage': 'ğŸ’»', 'power_outage': 'âš¡',
          'censorship': 'ğŸš«', 'cyber_attack': 'ğŸ›¡ï¸', 'infrastructure_damage': 'ğŸ—ï¸',
          'war_conflict': 'âš”ï¸', 'terrorism_explosion': 'ğŸ’£', 'natural_disaster': 'ğŸŒŠ',
          'protest_strike': 'ğŸ“¢', 'curfew': 'ğŸš«', 'pandemic': 'ğŸ¦ ', 'economic': 'ğŸ’°',
          'holiday': 'ğŸ‰', 'school_calendar': 'ğŸ“š', 'election': 'ğŸ—³ï¸',
          'gaming': 'ğŸ®', 'competitor_game': 'ğŸ¯', 'social_trend': 'ğŸ“±',
          'sports_event': 'âš½', 'major_event': 'ğŸª',
          'other': 'ğŸ“‹'
        };
        
        newsList.innerHTML = newsArray.map(news => {
          const groupColor = groupColors[news.category_group] || groupColors['other'];
          const categoryIcon = categoryIcons[news.category] || categoryIcons['other'];
          const categoryName = news.category.replace(/_/g, ' ');
          
          // ë‰´ìŠ¤ íƒ€ì… ìŠ¤íƒ€ì¼
          const typeStyle = newsTypeStyles[news.news_type] || newsTypeStyles['gaming'];
          const typeLabel = `<span style="padding:4px 10px;background:${typeStyle.bgColor};border:1px solid ${typeStyle.color};border-radius:4px;font-size:11px;color:${typeStyle.color};white-space:nowrap;font-weight:600">${typeStyle.icon} ${typeStyle.label}</span>`;
          
          return `
          <div class="news-item" style="border-left:3px solid ${typeStyle.color}">
            <div class="news-content">
              <div class="news-title" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                ${typeLabel}
                <a href="${news.url}" target="_blank" rel="noopener noreferrer" style="flex:1;min-width:200px">${news.title}</a>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
                <span style="padding:4px 10px;background:${groupColor}15;border:1px solid ${groupColor}50;border-radius:4px;font-size:11px;color:${groupColor}">
                  ${categoryIcon} ${categoryName}
                </span>
                ${news.country ? `<span style="padding:4px 10px;background:rgba(35,134,54,0.1);border:1px solid rgba(35,134,54,0.3);border-radius:4px;font-size:11px;color:#238636">ğŸŒ ${news.country}</span>` : ''}
                ${news.priority === 'high' ? `<span style="padding:3px 8px;background:rgba(255,107,107,0.15);border:1px solid rgba(255,107,107,0.3);border-radius:4px;font-size:10px;color:#ff6b6b">âš ï¸ HIGH</span>` : ''}
              </div>
              <div class="news-meta" style="margin-top:8px">
                <span class="news-source">${news.source}</span>
                <span class="news-date">${news.date}</span>
                ${news.continent ? `<span style="color:var(--muted);font-size:11px">${news.continent}</span>` : ''}
              </div>
              <div class="news-snippet" style="margin-top:8px">${news.summary}</div>
              ${news.traffic_impact ? `<div style="margin-top:10px;padding:10px;background:rgba(255,107,107,0.08);border-left:3px solid #ff6b6b;border-radius:4px;font-size:12px;color:var(--muted)"><strong style="color:#ff6b6b">ğŸ“Š íŠ¸ë˜í”½ ì˜í–¥ ë¶„ì„:</strong> ${news.traffic_impact}</div>` : ''}
              <div style="margin-top:10px;display:flex;gap:8px">
                <a href="${news.url}" target="_blank" rel="noopener noreferrer" style="padding:6px 12px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:#fff;font-size:12px;text-decoration:none;transition:all 0.2s" onmouseover="this.style.borderColor='#238636'" onmouseout="this.style.borderColor='var(--border)'">ğŸ“° ì›ë¬¸ ë³´ê¸°</a>
              </div>
            </div>
          </div>
        `;
        }).join('');
        
        const renderTime = performance.now() - renderStartTime;
        console.log(`ë Œë”ë§ ì‹œê°„: ${renderTime.toFixed(2)}ms, ë‰´ìŠ¤ ${newsArray.length}ê°œ`);
      } else {
        newsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“°</div>
            <div>í•´ë‹¹ í•„í„°ì— ë§ëŠ” ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div style="margin-top:12px;font-size:12px;color:var(--muted)">ë‹¤ë¥¸ í•„í„°ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.</div>
          </div>
        `;
      }
    }

    // ìƒ˜í”Œ ë‰´ìŠ¤ ë Œë”ë§ (í´ë°±)
    function renderSampleNews(countries = null){
      const newsList = document.getElementById('newsList');
      const sampleNews = [
        {
          title: 'PUBG Mobile ê¸€ë¡œë²Œ íŠ¸ë˜í”½ ì¦ê°€ ì¶”ì„¸',
          source: 'Gaming News',
          date: new Date().toLocaleDateString('ko-KR'),
          snippet: 'PUBG Mobileì˜ ê¸€ë¡œë²Œ íŠ¸ë˜í”½ì´ ì§€ì†ì ìœ¼ë¡œ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
          url: '#',
          relatedCountry: countries && countries.length > 0 ? countries[0].country : null
        },
        {
          title: 'ëª¨ë°”ì¼ ê²Œì„ ì‹œì¥ ë™í–¥ ë¶„ì„',
          source: 'Tech Report',
          date: new Date(Date.now() - 86400000).toLocaleDateString('ko-KR'),
          snippet: 'ëª¨ë°”ì¼ ê²Œì„ ì‹œì¥ì˜ íŠ¸ë˜í”½ ë³€í™”ë¥¼ ë¶„ì„í•œ ìµœì‹  ë¦¬í¬íŠ¸ê°€ ë°œí‘œë˜ì—ˆìŠµë‹ˆë‹¤.',
          url: '#',
          relatedCountry: null
        }
      ];
      
      renderNews(sampleNews);
    }

    // Load news for risers/fallers
    function loadNewsForRisersFallers(data){
      if(!data || !data.Country) return;
      
      const stats = calculateStats(data);
      const threshold = 5;
      
      const risers = [];
      const fallers = [];
      
      for(let i = 0; i < stats.topCountries.length; i++){
        const change = stats.topChange[i];
        const country = stats.topCountries[i];
        
        if(change >= threshold){
          risers.push({country, change, type: 'riser'});
        } else if(change <= -threshold){
          fallers.push({country, change, type: 'faller'});
        }
      }
      
      // Combine risers and fallers for news API
      const countriesForNews = [...risers, ...fallers];
      loadNews(countriesForNews);
    }


    // Update tabs when data changes
    const originalCreateTreemap = createTreemap;
    createTreemap = function(data){
      originalCreateTreemap(data);
      // Update other tabs if they are active
      if(document.getElementById('tab-risers-fallers').classList.contains('active')){
        updateRisersFallers(data);
      }
      if(document.getElementById('tab-country-detail').classList.contains('active')){
        updateCountrySelect(data);
      }
      if(document.getElementById('tab-news').classList.contains('active')){
        loadNewsFromCSV();
      }
    };

    // initial draw
    window.addEventListener('load',()=>{
      const t=overlay?.querySelector('.loading-text'); if(t) t.textContent='ìƒ˜í”Œ ë°ì´í„°ë¡œ ì´ˆê¸°í™” ì¤‘...';
      setTimeout(()=> {
        createTreemap(currentData);
        updateCountrySelect(currentData);
      }, 120);
    });
    </script>
</body>
</html>